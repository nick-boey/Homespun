@using Homespun.Features.ClaudeCode.Data

<div class="session-info-panel @(IsOpen ? "" : "collapsed")">
    <button class="toggle-button" @onclick="TogglePanel" title="@(IsOpen ? "Collapse panel" : "Expand panel")">
        @(IsOpen ? "‚Üí" : "‚Üê")
    </button>

    @if (IsOpen)
    {
        @if (Session == null)
        {
            <div class="panel-empty-state">
                <span class="empty-icon">üìä</span>
                <p>No session loaded</p>
            </div>
        }
        else
        {
            <div class="panel-tabs">
                <button class="tab-button @(_activeTab == Tab.Issue ? "active" : "")"
                        @onclick="() => SetActiveTab(Tab.Issue)">
                    Issue
                </button>
                <button class="tab-button @(_activeTab == Tab.PR ? "active" : "")"
                        @onclick="() => SetActiveTab(Tab.PR)">
                    PR
                </button>
                <button class="tab-button @(_activeTab == Tab.Todos ? "active" : "")"
                        @onclick="() => SetActiveTab(Tab.Todos)">
                    To-do's
                </button>
                <button class="tab-button @(_activeTab == Tab.Files ? "active" : "")"
                        @onclick="() => SetActiveTab(Tab.Files)">
                    Files
                </button>
            </div>

            <div class="panel-content">
                @switch (_activeTab)
                {
                    case Tab.Issue:
                        <SessionIssueTab EntityId="@Session.EntityId" ProjectId="@Session.ProjectId" />
                        break;
                    case Tab.PR:
                        <SessionPrTab EntityId="@Session.EntityId" ProjectId="@Session.ProjectId" />
                        break;
                    case Tab.Todos:
                        <SessionTodosTab Messages="@Session.Messages" />
                        break;
                    case Tab.Files:
                        <SessionFilesTab WorkingDirectory="@Session.WorkingDirectory" TargetBranch="main" />
                        break;
                }
            </div>
        }
    }
</div>

<style>
    .session-info-panel {
        display: flex;
        flex-direction: column;
        width: 320px;
        min-width: 320px;
        height: 100%;
        background: var(--bg-secondary);
        border-left: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        overflow: hidden;
        transition: width 0.2s ease, min-width 0.2s ease;
    }

    .session-info-panel.collapsed {
        width: 40px;
        min-width: 40px;
    }

    .toggle-button {
        position: absolute;
        top: var(--spacing-sm);
        right: var(--spacing-sm);
        width: 28px;
        height: 28px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-color);
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        z-index: 10;
        transition: background 0.15s ease;
    }

    .toggle-button:hover {
        background: var(--bg-primary);
        border-color: var(--color-lagoon);
        color: var(--color-lagoon);
    }

    .collapsed .toggle-button {
        position: relative;
        margin: var(--spacing-sm) auto;
    }

    .panel-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: var(--spacing-lg);
        color: var(--text-muted);
        text-align: center;
        gap: var(--spacing-sm);
    }

    .panel-empty-state .empty-icon {
        font-size: 2.5rem;
        opacity: 0.5;
    }

    .panel-empty-state p {
        margin: 0;
        font-size: 0.875rem;
    }

    .panel-tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-tertiary);
        padding: 0 var(--spacing-sm);
        padding-top: var(--spacing-sm);
    }

    .tab-button {
        flex: 1;
        padding: var(--spacing-sm) var(--spacing-xs);
        border: none;
        border-bottom: 2px solid transparent;
        background: transparent;
        color: var(--text-muted);
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        white-space: nowrap;
    }

    .tab-button:hover {
        color: var(--text-primary);
        background: var(--bg-secondary);
    }

    .tab-button.active {
        color: var(--color-lagoon);
        border-bottom-color: var(--color-lagoon);
    }

    .panel-content {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* Ensure child components fill the space */
    .panel-content > :deep(*) {
        flex: 1;
        overflow-y: auto;
    }
</style>

@code {
    [Parameter] public ClaudeSession? Session { get; set; }
    [Parameter] public bool IsOpen { get; set; } = true;
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }

    private Tab _activeTab = Tab.Issue;

    private enum Tab
    {
        Issue,
        PR,
        Todos,
        Files
    }

    private void SetActiveTab(Tab tab)
    {
        _activeTab = tab;
        StateHasChanged();
    }

    private async Task TogglePanel()
    {
        IsOpen = !IsOpen;
        await IsOpenChanged.InvokeAsync(IsOpen);
    }
}
