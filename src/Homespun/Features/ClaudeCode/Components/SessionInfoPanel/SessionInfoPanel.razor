@using Homespun.Features.ClaudeCode.Data

<!-- Desktop: side panel (hidden on mobile) -->
<div class="session-info-panel desktop-panel @(IsOpen ? "" : "collapsed")">
    <button class="toggle-button" @onclick="TogglePanel" title="@(IsOpen ? "Collapse panel" : "Expand panel")">
        @(IsOpen ? "‚Üí" : "‚Üê")
    </button>

    @if (IsOpen)
    {
        @if (Session == null)
        {
            <div class="panel-empty-state">
                <span class="empty-icon">üìä</span>
                <p>No session loaded</p>
            </div>
        }
        else
        {
            <ul class="nav nav-tabs panel-nav-tabs">
                <li class="nav-item">
                    <a class="nav-link @(_activeTab == Tab.Issue ? "active" : "")"
                       href="#"
                       @onclick="() => SetActiveTab(Tab.Issue)"
                       @onclick:preventDefault>
                        Issue
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(_activeTab == Tab.PR ? "active" : "")"
                       href="#"
                       @onclick="() => SetActiveTab(Tab.PR)"
                       @onclick:preventDefault>
                        PR
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(_activeTab == Tab.Todos ? "active" : "")"
                       href="#"
                       @onclick="() => SetActiveTab(Tab.Todos)"
                       @onclick:preventDefault>
                        To-do's
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(_activeTab == Tab.Files ? "active" : "")"
                       href="#"
                       @onclick="() => SetActiveTab(Tab.Files)"
                       @onclick:preventDefault>
                        Files
                    </a>
                </li>
            </ul>

            <div class="panel-content">
                @if (_activeTab == Tab.Issue)
                {
                    <SessionIssueTab EntityId="@Session.EntityId" ProjectId="@Session.ProjectId" />
                }
                else if (_activeTab == Tab.PR)
                {
                    <SessionPrTab EntityId="@Session.EntityId" ProjectId="@Session.ProjectId" />
                }
                else if (_activeTab == Tab.Todos)
                {
                    <SessionTodosTab Messages="@Session.Messages" />
                }
                else if (_activeTab == Tab.Files)
                {
                    <SessionFilesTab WorkingDirectory="@Session.WorkingDirectory" TargetBranch="main" />
                }
            </div>
        }
    }
</div>

<!-- Mobile: collapsible top section (hidden on desktop) -->
<div class="session-info-panel mobile-panel">
    @if (Session != null)
    {
        <details class="mobile-details">
            <summary class="mobile-summary">
                <span class="mobile-summary-title">@(IssueTitle ?? "Session Details")</span>
                <span class="mobile-chevron">‚ñæ</span>
            </summary>
            <div class="mobile-panel-body">
                <ul class="nav nav-tabs panel-nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link @(_activeTab == Tab.Issue ? "active" : "")"
                           href="#"
                           @onclick="() => SetActiveTab(Tab.Issue)"
                           @onclick:preventDefault>
                            Issue
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(_activeTab == Tab.PR ? "active" : "")"
                           href="#"
                           @onclick="() => SetActiveTab(Tab.PR)"
                           @onclick:preventDefault>
                            PR
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(_activeTab == Tab.Todos ? "active" : "")"
                           href="#"
                           @onclick="() => SetActiveTab(Tab.Todos)"
                           @onclick:preventDefault>
                            To-do's
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(_activeTab == Tab.Files ? "active" : "")"
                           href="#"
                           @onclick="() => SetActiveTab(Tab.Files)"
                           @onclick:preventDefault>
                            Files
                        </a>
                    </li>
                </ul>

                <div class="panel-content">
                    @if (_activeTab == Tab.Issue)
                    {
                        <SessionIssueTab EntityId="@Session.EntityId" ProjectId="@Session.ProjectId" />
                    }
                    else if (_activeTab == Tab.PR)
                    {
                        <SessionPrTab EntityId="@Session.EntityId" ProjectId="@Session.ProjectId" />
                    }
                    else if (_activeTab == Tab.Todos)
                    {
                        <SessionTodosTab Messages="@Session.Messages" />
                    }
                    else if (_activeTab == Tab.Files)
                    {
                        <SessionFilesTab WorkingDirectory="@Session.WorkingDirectory" TargetBranch="main" />
                    }
                </div>
            </div>
        </details>
    }
</div>

<style>
    /* ===== Desktop Panel (side panel) ===== */
    .desktop-panel {
        display: flex;
        flex-direction: column;
        width: 320px;
        min-width: 320px;
        height: 100%;
        background: var(--bg-secondary);
        border-left: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        overflow: hidden;
        transition: width 0.2s ease, min-width 0.2s ease;
    }

    .desktop-panel.collapsed {
        width: 40px;
        min-width: 40px;
    }

    .toggle-button {
        position: absolute;
        top: var(--spacing-sm);
        right: var(--spacing-sm);
        width: 28px;
        height: 28px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-color);
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        z-index: 10;
        transition: background 0.15s ease;
    }

    .toggle-button:hover {
        background: var(--bg-primary);
        border-color: var(--color-lagoon);
        color: var(--color-lagoon);
    }

    .collapsed .toggle-button {
        position: relative;
        margin: var(--spacing-sm) auto;
    }

    /* ===== Mobile Panel (collapsible top section) ===== */
    .mobile-panel {
        display: none;
    }

    .mobile-details {
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        background: var(--bg-secondary);
        overflow: hidden;
    }

    .mobile-summary {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-sm) var(--spacing-md);
        cursor: pointer;
        user-select: none;
        list-style: none;
        background: var(--bg-tertiary);
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--text-primary);
    }

    .mobile-summary::-webkit-details-marker {
        display: none;
    }

    .mobile-summary:hover {
        background: var(--bg-secondary);
    }

    .mobile-summary-title {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-right: var(--spacing-sm);
    }

    .mobile-chevron {
        font-size: 0.75rem;
        color: var(--text-muted);
        transition: transform 0.2s ease;
        flex-shrink: 0;
    }

    .mobile-details[open] .mobile-chevron {
        transform: rotate(180deg);
    }

    .mobile-panel-body {
        max-height: 50vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border-top: 1px solid var(--border-color);
    }

    /* ===== Shared styles ===== */
    .panel-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: var(--spacing-lg);
        color: var(--text-muted);
        text-align: center;
        gap: var(--spacing-sm);
    }

    .panel-empty-state .empty-icon {
        font-size: 2.5rem;
        opacity: 0.5;
    }

    .panel-empty-state p {
        margin: 0;
        font-size: 0.875rem;
    }

    .panel-nav-tabs {
        flex-shrink: 0;
    }

    .panel-nav-tabs .nav-link {
        font-size: 0.75rem;
        padding: var(--spacing-xs) var(--spacing-sm);
    }

    .panel-content {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* Ensure child components fill the space */
    .panel-content > :deep(*) {
        flex: 1;
        overflow-y: auto;
    }

    /* ===== Responsive: show/hide desktop vs mobile ===== */
    @@media (max-width: 768px) {
        .desktop-panel {
            display: none !important;
        }

        .mobile-panel {
            display: block;
        }
    }
</style>

@code {
    [Parameter] public ClaudeSession? Session { get; set; }
    [Parameter] public bool IsOpen { get; set; } = true;
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public string? IssueTitle { get; set; }

    private Tab _activeTab = Tab.Issue;

    private enum Tab
    {
        Issue,
        PR,
        Todos,
        Files
    }

    private void SetActiveTab(Tab tab)
    {
        _activeTab = tab;
        StateHasChanged();
    }

    private async Task TogglePanel()
    {
        IsOpen = !IsOpen;
        await IsOpenChanged.InvokeAsync(IsOpen);
    }

}
