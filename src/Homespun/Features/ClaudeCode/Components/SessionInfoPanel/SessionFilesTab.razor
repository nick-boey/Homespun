@using Homespun.Features.ClaudeCode.Data
@using Homespun.Features.Git
@inject IGitWorktreeService GitService

<div class="files-tab">
    @if (string.IsNullOrEmpty(WorkingDirectory))
    {
        <div class="empty-state">
            <span class="empty-icon">üìÅ</span>
            <p>No working directory available</p>
        </div>
    }
    else if (_isLoading)
    {
        <div class="loading-state">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            <span>Loading files...</span>
        </div>
    }
    else if (_files.Count == 0)
    {
        <div class="empty-state">
            <span class="empty-icon">üìÑ</span>
            <p>No file changes detected</p>
        </div>
    }
    else
    {
        <div class="files-header">
            <span class="file-count">@_files.Count file@(_files.Count != 1 ? "s" : "") changed</span>
        </div>
        <div class="files-list">
            @foreach (var file in _files)
            {
                <div class="file-item">
                    <span class="status-icon @GetStatusClass(file.Status)">@GetStatusIcon(file.Status)</span>
                    <span class="file-path" title="@file.FilePath">@file.FilePath</span>
                    <span class="file-stats">
                        @if (file.Additions > 0)
                        {
                            <span class="additions">+@file.Additions</span>
                        }
                        @if (file.Deletions > 0)
                        {
                            <span class="deletions">-@file.Deletions</span>
                        }
                    </span>
                </div>
            }
        </div>
    }
</div>

<style>
    .files-tab {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .loading-state,
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-lg);
        color: var(--text-muted);
        text-align: center;
        gap: var(--spacing-sm);
    }

    .empty-icon {
        font-size: 2rem;
        opacity: 0.5;
    }

    .empty-state p {
        margin: 0;
        font-size: 0.875rem;
    }

    .files-header {
        padding: var(--spacing-sm);
        border-bottom: 1px solid var(--border-color);
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .files-list {
        flex: 1;
        overflow-y: auto;
    }

    .file-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-bottom: 1px solid var(--border-color);
        font-size: 0.8125rem;
    }

    .file-item:last-child {
        border-bottom: none;
    }

    .file-item:hover {
        background: var(--bg-secondary);
    }

    .status-icon {
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: bold;
        border-radius: var(--radius-sm);
        flex-shrink: 0;
    }

    .status-icon.added {
        color: var(--status-success);
        background: rgba(40, 167, 69, 0.1);
    }

    .status-icon.modified {
        color: var(--status-warning);
        background: rgba(255, 193, 7, 0.1);
    }

    .status-icon.deleted {
        color: var(--status-error);
        background: rgba(220, 53, 69, 0.1);
    }

    .status-icon.renamed {
        color: var(--color-lagoon);
        background: rgba(66, 153, 225, 0.1);
    }

    .file-path {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-family: monospace;
        color: var(--text-secondary);
    }

    .file-stats {
        display: flex;
        gap: var(--spacing-xs);
        font-size: 0.75rem;
        font-family: monospace;
        flex-shrink: 0;
    }

    .additions {
        color: var(--status-success);
    }

    .deletions {
        color: var(--status-error);
    }
</style>

@code {
    [Parameter] public string? WorkingDirectory { get; set; }
    [Parameter] public string TargetBranch { get; set; } = "main";

    private List<FileChangeInfo> _files = [];
    private bool _isLoading = true;

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(WorkingDirectory))
        {
            await LoadFilesAsync();
        }
        else
        {
            _isLoading = false;
        }
    }

    private async Task LoadFilesAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            _files = await GitService.GetChangedFilesAsync(WorkingDirectory!, TargetBranch);
        }
        catch
        {
            _files = [];
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private static string GetStatusClass(FileChangeStatus status) => status switch
    {
        FileChangeStatus.Added => "added",
        FileChangeStatus.Modified => "modified",
        FileChangeStatus.Deleted => "deleted",
        FileChangeStatus.Renamed => "renamed",
        _ => "modified"
    };

    private static string GetStatusIcon(FileChangeStatus status) => status switch
    {
        FileChangeStatus.Added => "+",
        FileChangeStatus.Modified => "‚óè",
        FileChangeStatus.Deleted => "-",
        FileChangeStatus.Renamed => "‚Üí",
        _ => "‚óè"
    };
}
