@using Homespun.Features.ClaudeCode.Data
@using Homespun.Features.ClaudeCode.Services

@inject IClaudeSessionStore SessionStore
@inject IClaudeSessionService SessionService
@inject IAgentStartupTracker StartupTracker
@inject IAgentPromptService AgentPromptService
@inject NavigationManager NavigationManager
@inject ILogger<AgentControlPanel> Logger

@*
    Reusable component for managing Claude agent sessions.
    Shows appropriate controls based on session state:
    - No session: AgentSelector + Start button
    - Starting: Spinner
    - Active session: Status badge + Chat link + Stop button
*@

@if (_isStarting)
{
    <div class="agent-control-panel @(Compact ? "compact" : "")">
        <span class="badge bg-warning text-dark">
            <span class="spinner-border spinner-border-sm me-1" role="status" style="width: 0.6rem; height: 0.6rem;"></span>
            Starting...
        </span>
    </div>
}
else if (_session != null)
{
    <div class="agent-control-panel @(Compact ? "compact" : "") d-flex align-items-center gap-2">
        <span class="badge @_session.Status.ToBadgeClass()">
            @_session.Status.ToDisplayLabel()
        </span>
        <a href="/session/@_session.Id" class="btn btn-sm btn-primary">
            Chat
        </a>
        <button class="btn btn-sm btn-outline-danger"
                @onclick="StopSessionAsync"
                disabled="@_isLoading">
            @if (_isLoading)
            {
                <span class="spinner-border spinner-border-sm" role="status" style="width: 0.6rem; height: 0.6rem;"></span>
            }
            else
            {
                <span>Stop</span>
            }
        </button>
    </div>
}
else
{
    <div class="agent-control-panel @(Compact ? "compact" : "")">
        <AgentSelector
            Disabled="@Disabled"
            IsStarting="@_isStarting"
            OnStart="HandleAgentStart" />
    </div>
}

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger alert-sm mt-1 mb-0 py-1 px-2 small">@_errorMessage</div>
}

<style>
    .agent-control-panel.compact {
        font-size: 0.875rem;
    }

    .agent-control-panel.compact .btn-sm {
        padding: 0.2rem 0.5rem;
        font-size: 0.75rem;
    }

    .alert-sm {
        font-size: 0.75rem;
    }
</style>

@code {
    /// <summary>
    /// Unique identifier for session tracking (e.g., issue ID or clone entity ID).
    /// </summary>
    [Parameter, EditorRequired]
    public required string EntityId { get; set; }

    /// <summary>
    /// Path to the clone where the agent will operate.
    /// </summary>
    [Parameter, EditorRequired]
    public required string ClonePath { get; set; }

    /// <summary>
    /// Project identifier.
    /// </summary>
    [Parameter, EditorRequired]
    public required string ProjectId { get; set; }

    /// <summary>
    /// Default model to use for the session.
    /// </summary>
    [Parameter]
    public string Model { get; set; } = "sonnet";

    /// <summary>
    /// Optional system prompt for the session.
    /// </summary>
    [Parameter]
    public string? SystemPrompt { get; set; }

    /// <summary>
    /// Whether to use compact layout (smaller buttons/text).
    /// </summary>
    [Parameter]
    public bool Compact { get; set; }

    /// <summary>
    /// Whether the controls should be disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Callback when a session is successfully started.
    /// </summary>
    [Parameter]
    public EventCallback<ClaudeSession> OnSessionStarted { get; set; }

    /// <summary>
    /// Callback when a session is stopped.
    /// </summary>
    [Parameter]
    public EventCallback OnSessionStopped { get; set; }

    private ClaudeSession? _session;
    private bool _isStarting;
    private bool _isLoading;
    private string? _errorMessage;

    protected override void OnInitialized()
    {
        UpdateSessionState();
    }

    protected override void OnParametersSet()
    {
        UpdateSessionState();
    }

    private void UpdateSessionState()
    {
        _session = SessionStore.GetByEntityId(EntityId);
        _isStarting = StartupTracker.IsStarting(EntityId);
    }

    private async Task HandleAgentStart(AgentPrompt? selectedPrompt)
    {
        _errorMessage = null;
        if (!StartupTracker.TryMarkAsStarting(EntityId)) return;
        _isStarting = true;
        StateHasChanged();

        try
        {
            var mode = selectedPrompt?.Mode ?? SessionMode.Build;

            _session = await SessionService.StartSessionAsync(
                EntityId,
                ProjectId,
                ClonePath,
                mode,
                Model,
                SystemPrompt);

            StartupTracker.MarkAsStarted(EntityId);

            // Send initial message if prompt has one
            if (selectedPrompt != null && !string.IsNullOrEmpty(selectedPrompt.InitialMessage))
            {
                var initialMessage = AgentPromptService.RenderTemplate(selectedPrompt.InitialMessage, new PromptContext
                {
                    Id = EntityId,
                    Branch = Path.GetFileName(ClonePath) ?? ""
                });

                if (!string.IsNullOrEmpty(initialMessage))
                {
                    await SessionService.SendMessageAsync(_session.Id, initialMessage);
                }
            }

            await OnSessionStarted.InvokeAsync(_session);

            // Navigate to session page
            NavigationManager.NavigateTo($"/session/{_session.Id}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to start session for entity {EntityId}", EntityId);
            StartupTracker.MarkAsFailed(EntityId, ex.Message);
            StartupTracker.Clear(EntityId);
            _errorMessage = $"Failed to start: {ex.Message}";
            _session = null;
        }
        finally
        {
            _isStarting = false;
            StateHasChanged();
        }
    }

    private async Task StopSessionAsync()
    {
        if (_session == null) return;

        _isLoading = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            await SessionService.StopSessionAsync(_session.Id);
            _session = null;
            await OnSessionStopped.InvokeAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to stop session {SessionId}", _session?.Id);
            _errorMessage = $"Failed to stop: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
}
