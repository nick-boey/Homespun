@using Homespun.Features.Notifications
@inject INotificationService NotificationService
@implements IDisposable

@if (_notifications.Count > 0)
{
    <div class="notification-banner-container">
        @foreach (var notification in _notifications)
        {
            <div class="notification-banner notification-@notification.Type.ToString().ToLower()">
                <div class="notification-content">
                    <div class="notification-icon">
                        @GetIcon(notification.Type)
                    </div>
                    <div class="notification-text">
                        <span class="notification-title">@notification.Title</span>
                        <span class="notification-message">@notification.Message</span>
                    </div>
                </div>
                <div class="notification-actions">
                    @if (!string.IsNullOrEmpty(notification.ActionLabel) && notification.Action != null)
                    {
                        <button class="btn btn-sm notification-action-btn" @onclick="() => HandleAction(notification)">
                            @notification.ActionLabel
                        </button>
                    }
                    @if (notification.IsDismissible)
                    {
                        <button class="notification-dismiss" @onclick="() => Dismiss(notification.Id)" title="Dismiss">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    }
                </div>
            </div>
        }
    </div>
}

@code {
    /// <summary>
    /// Optional project ID to filter notifications by project.
    /// </summary>
    [Parameter]
    public string? ProjectId { get; set; }

    private List<Notification> _notifications = new();

    protected override void OnInitialized()
    {
        NotificationService.OnNotificationAdded += HandleNotificationAdded;
        NotificationService.OnNotificationDismissed += HandleNotificationDismissed;
        RefreshNotifications();
    }

    protected override void OnParametersSet()
    {
        RefreshNotifications();
    }

    private void RefreshNotifications()
    {
        _notifications = NotificationService.GetActiveNotifications(ProjectId).ToList();
    }

    private void HandleNotificationAdded(Notification notification)
    {
        InvokeAsync(() =>
        {
            RefreshNotifications();
            StateHasChanged();
        });
    }

    private void HandleNotificationDismissed(string notificationId)
    {
        InvokeAsync(() =>
        {
            RefreshNotifications();
            StateHasChanged();
        });
    }

    private async Task HandleAction(Notification notification)
    {
        if (notification.Action != null)
        {
            await notification.Action();
        }
    }

    private void Dismiss(string notificationId)
    {
        NotificationService.DismissNotification(notificationId);
    }

    private static MarkupString GetIcon(NotificationType type)
    {
        var svg = type switch
        {
            NotificationType.Info => """<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>""",
            NotificationType.Warning => """<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>""",
            NotificationType.ActionRequired => """<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>""",
            _ => """<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>"""
        };
        return new MarkupString(svg);
    }

    public void Dispose()
    {
        NotificationService.OnNotificationAdded -= HandleNotificationAdded;
        NotificationService.OnNotificationDismissed -= HandleNotificationDismissed;
    }
}
