@using Homespun.Features.Roadmap.Sync

<div class="dialog-overlay @(_isVisible ? "visible" : "")" @onclick="Close">
    <div class="dialog-content" @onclick:stopPropagation="true">
        <div class="dialog-header">
            <h3>Roadmap Conflict</h3>
            <button class="dialog-close" @onclick="Close" title="Close">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        @if (_conflict != null)
        {
            <div class="dialog-body">
                <div class="conflict-info">
                    <div class="conflict-branch">
                        <span class="label">Branch:</span>
                        <code>@_conflict.BranchName</code>
                    </div>
                    @if (!string.IsNullOrEmpty(_conflict.PullRequestTitle))
                    {
                        <div class="conflict-pr">
                            <span class="label">Pull Request:</span>
                            <span>@_conflict.PullRequestTitle</span>
                        </div>
                    }
                    <div class="conflict-description">
                        <p>@_conflict.Description</p>
                    </div>
                </div>

                <div class="resolution-options">
                    <p class="options-label">How would you like to resolve this conflict?</p>
                    
                    <div class="option-card" @onclick="() => SelectResolution(ConflictResolution.KeepExisting)">
                        <div class="option-header">
                            <div class="option-radio @(_selectedResolution == ConflictResolution.KeepExisting ? "selected" : "")"></div>
                            <span class="option-title">Keep Existing</span>
                        </div>
                        <p class="option-description">
                            Keep the roadmap changes in this branch. The changes will be reviewed as part of the pull request.
                        </p>
                    </div>

                    <div class="option-card" @onclick="() => SelectResolution(ConflictResolution.UseNew)">
                        <div class="option-header">
                            <div class="option-radio @(_selectedResolution == ConflictResolution.UseNew ? "selected" : "")"></div>
                            <span class="option-title">Use New Roadmap</span>
                        </div>
                        <p class="option-description">
                            Overwrite with the current roadmap. The branch's roadmap changes will be lost.
                        </p>
                    </div>
                </div>
            </div>

            <div class="dialog-footer">
                <button class="btn btn-secondary" @onclick="Close">Cancel</button>
                <button class="btn btn-primary" @onclick="Resolve" disabled="@(_selectedResolution == null || _isResolving)">
                    @if (_isResolving)
                    {
                        <span>Resolving...</span>
                    }
                    else
                    {
                        <span>Resolve Conflict</span>
                    }
                </button>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public EventCallback<(WorktreeConflict Conflict, ConflictResolution Resolution)> OnResolved { get; set; }

    private bool _isVisible;
    private bool _isResolving;
    private WorktreeConflict? _conflict;
    private ConflictResolution? _selectedResolution;

    public void Show(WorktreeConflict conflict)
    {
        _conflict = conflict;
        _selectedResolution = null;
        _isResolving = false;
        _isVisible = true;
        StateHasChanged();
    }

    public void Close()
    {
        _isVisible = false;
        _conflict = null;
        _selectedResolution = null;
        StateHasChanged();
    }

    private void SelectResolution(ConflictResolution resolution)
    {
        _selectedResolution = resolution;
    }

    private async Task Resolve()
    {
        if (_conflict == null || _selectedResolution == null) return;

        _isResolving = true;
        StateHasChanged();

        await OnResolved.InvokeAsync((_conflict, _selectedResolution.Value));

        _isResolving = false;
        Close();
    }
}
