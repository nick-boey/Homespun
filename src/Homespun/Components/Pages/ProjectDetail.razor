@page "/projects/{Id}"
@using Homespun.Features.GitHub
@using Homespun.Features.Projects
@using Homespun.Features.PullRequests
@using Homespun.Features.PullRequests.Data
@using Homespun.Features.PullRequests.Data.Entities
@using Homespun.Features.Roadmap
@inject ProjectService ProjectService
@inject PullRequestDataService PullRequestDataService
@inject PullRequestWorkflowService PullRequestWorkflowService
@inject IRoadmapService RoadmapService
@inject IGitHubService GitHubService
@inject ILogger<ProjectDetail> Logger
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>@(_project?.Name ?? "Project")</PageTitle>

@if (_project == null)
{
    <p>Loading...</p>
}
else
{
    <div class="project-layout">
        <div class="timeline-column">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1>@_project.Name</h1>
                <div>
                    <a href="projects/@Id/edit" class="btn btn-outline-secondary btn-sm">Edit Project</a>
                </div>
            </div>

            <div class="timeline-list">
                @* Past PRs - from GitHub (oldest to newest) *@
                @if (_isLoadingPastPRs)
                {
                    <div class="timeline-section-header">
                        <span class="section-title">Past Pull Requests</span>
                        <span class="spinner-border spinner-border-sm ms-2" role="status"></span>
                    </div>
                }
                else if (_pastPRs != null && _pastPRs.Count > 0)
                {
                    var orderedPastPRs = _pastPRs.OrderBy(p => p.Time).ToList();
                    var hiddenCount = Math.Max(0, orderedPastPRs.Count - _pastPRsDisplayCount);
                    var visiblePastPRs = orderedPastPRs.Skip(hiddenCount).ToList();
                    
                    <div class="timeline-section-header">
                        <span class="section-title">Past Pull Requests</span>
                        <span class="section-count">@_pastPRs.Count</span>
                    </div>
                    @if (hiddenCount > 0)
                    {
                        <button class="load-more-btn" @onclick="LoadMorePastPRs">
                            ... and @hiddenCount older PRs (click to load @Math.Min(5, hiddenCount) more)
                        </button>
                    }
                    @for (var i = 0; i < visiblePastPRs.Count; i++)
                    {
                        var prWithTime = visiblePastPRs[i];
                        var isFirst = i == 0 && hiddenCount == 0;
                        var isLast = i == visiblePastPRs.Count - 1;
                        <WorkItem Title="@prWithTime.PullRequest.Title"
                                  Number="@prWithTime.PullRequest.Number"
                                  Url="@prWithTime.PullRequest.HtmlUrl"
                                  StatusColor="@GetPastPRStatusColor(prWithTime.PullRequest.Status)"
                                  StatusTooltip="@prWithTime.PullRequest.Status.ToString()"
                                  Subtitle="@GetPastPRSubtitle(prWithTime.PullRequest)"
                                  IsFirst="@isFirst"
                                  IsLast="@isLast" />
                    }
                    <div class="timeline-divider"></div>
                }

                @* Current PRs - from database *@
                <div class="timeline-section-header">
                    <span class="section-title">Current Pull Requests</span>
                    @if (_rootPullRequests != null && _rootPullRequests.Count > 0)
                    {
                        <span class="section-count">@GetTotalCurrentPRCount()</span>
                    }
                </div>
                @if (_rootPullRequests == null || _rootPullRequests.Count == 0)
                {
                    <div class="empty-message">No open pull requests.</div>
                }
                else
                {
                    @for (var i = 0; i < _flattenedCurrentPRs.Count; i++)
                    {
                        var pr = _flattenedCurrentPRs[i];
                        var isFirst = i == 0;
                        var isLast = i == _flattenedCurrentPRs.Count - 1;
                        <WorkItem Title="@pr.PullRequest.Title"
                                  Number="@pr.PullRequest.GitHubPRNumber"
                                  StatusColor="@GetCurrentPRStatusColor(pr.PullRequest.Status)"
                                  StatusTooltip="@pr.PullRequest.Status.ToString()"
                                  Subtitle="@GetCurrentPRSubtitle(pr.PullRequest)"
                                  IndentLevel="@pr.Level"
                                  IsSelected="@(_selectedPullRequestId == pr.PullRequest.Id)"
                                  IsClickable="true"
                                  IsFirst="@isFirst"
                                  IsLast="@isLast"
                                  OnClick="@(() => SelectPullRequest(pr.PullRequest.Id))" />
                    }
                }
                <div class="timeline-divider"></div>

                @* Future Changes - from ROADMAP.json *@
                <div class="timeline-section-header">
                    <span class="section-title">Future Changes</span>
                    @if (_futureChanges != null && _futureChanges.Count > 0)
                    {
                        <span class="section-count">@_futureChanges.Count</span>
                    }
                    <a href="projects/@Id/features/create" class="btn btn-primary btn-sm ms-auto">New</a>
                </div>
                @if (_futureChanges == null || _futureChanges.Count == 0)
                {
                    <div class="empty-message">No future changes defined in ROADMAP.json.</div>
                }
                else
                {
                    @for (var i = 0; i < _futureChanges.Count; i++)
                    {
                        var change = _futureChanges[i];
                        var isFirst = i == 0;
                        var isLast = i == _futureChanges.Count - 1;
                        <WorkItem Title="@change.Change.Title"
                                  StatusColor="@GetChangeTypeStatusColor(change.Change.Type)"
                                  StatusTooltip="@change.Change.Type.ToString()"
                                  Subtitle="@GetFutureChangeSubtitle(change.Change)"
                                  IndentLevel="@change.Depth"
                                  IsFirst="@isFirst"
                                  IsLast="@isLast" />
                    }
                }
            </div>
        </div>

        <div class="detail-column">
            @if (_selectedPullRequest != null)
            {
                <FeatureDetailPanel PullRequest="_selectedPullRequest"
                                    OnActionCompleted="RefreshData"
                                    OnClose="() => _selectedPullRequest = null" />
            }
            else
            {
                <div class="card">
                    <div class="card-header">Project Info</div>
                    <div class="card-body">
                        <dl class="info-list">
                            <dt>Local Path</dt>
                            <dd><code>@_project.LocalPath</code></dd>
                            <dt>Default Branch</dt>
                            <dd>@_project.DefaultBranch</dd>
                            @if (!string.IsNullOrEmpty(_project.GitHubOwner) && !string.IsNullOrEmpty(_project.GitHubRepo))
                            {
                                <dt>GitHub</dt>
                                <dd>
                                    <a href="https://github.com/@_project.GitHubOwner/@_project.GitHubRepo" target="_blank">
                                        @_project.GitHubOwner/@_project.GitHubRepo
                                    </a>
                                    @if (_isSyncingPRs)
                                    {
                                        <span class="badge bg-info ms-2">
                                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                            Syncing...
                                        </span>
                                    }
                                    else if (_tokenMissing)
                                    {
                                        <span class="badge bg-warning text-dark ms-2" title="Set GITHUB_TOKEN environment variable">Token missing</span>
                                        <button class="btn btn-sm btn-link p-0 ms-1" @onclick="SyncPullRequestsAsync">Retry</button>
                                    }
                                    else if (_syncError != null)
                                    {
                                        <span class="badge bg-danger ms-2" title="@_syncError">Sync failed</span>
                                        <button class="btn btn-sm btn-link p-0 ms-1" @onclick="SyncPullRequestsAsync">Retry</button>
                                    }
                                    else if (_lastSyncResult != null)
                                    {
                                        <span class="badge bg-success ms-2" title="Imported: @_lastSyncResult.Imported, Updated: @_lastSyncResult.Updated, Removed: @_lastSyncResult.Removed">
                                            Synced
                                        </span>
                                        <button class="btn btn-sm btn-link p-0 ms-1" @onclick="SyncPullRequestsAsync">Refresh</button>
                                    }
                                </dd>
                            }
                        </dl>
                    </div>
                </div>
            }
        </div>
    </div>
}

<style>
    .project-layout {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: var(--spacing-md);
        align-items: start;
    }
    
    @@media (max-width: 900px) {
        .project-layout {
            grid-template-columns: 1fr;
        }
        
        .detail-column {
            order: -1;
        }
    }
    
    .timeline-column {
        min-width: 0;
    }
    
    .detail-column {
        position: sticky;
        top: var(--spacing-md);
    }
    
    .timeline-list {
        display: flex;
        flex-direction: column;
    }
    
    .timeline-section-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) 0;
        font-size: 0.75rem;
        font-weight: var(--font-weight-semibold);
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .section-count {
        background: var(--bg-tertiary);
        padding: 0.125rem 0.375rem;
        border-radius: var(--radius-full);
        font-size: 0.6875rem;
    }
    
    .timeline-divider {
        height: 1px;
        background: var(--border-color);
        margin: var(--spacing-sm) 0;
    }
    
    .empty-message {
        font-size: 0.8125rem;
        color: var(--text-muted);
        padding: var(--spacing-xs) var(--spacing-sm);
    }
    
    .load-more-btn {
        display: block;
        width: 100%;
        padding: var(--spacing-xs) var(--spacing-sm);
        margin-bottom: var(--spacing-xs);
        background: var(--bg-tertiary);
        border: 1px dashed var(--border-color);
        border-radius: var(--radius-sm);
        color: var(--text-muted);
        font-size: 0.75rem;
        text-align: left;
        cursor: pointer;
        transition: all var(--transition-fast);
    }
    
    .load-more-btn:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
        border-color: var(--border-color-light);
    }
    
    .info-list {
        margin: 0;
        font-size: 0.8125rem;
    }
    
    .info-list dt {
        font-weight: var(--font-weight-medium);
        color: var(--text-secondary);
        margin-top: var(--spacing-sm);
    }
    
    .info-list dt:first-child {
        margin-top: 0;
    }
    
    .info-list dd {
        margin: 0;
        margin-top: 0.125rem;
    }
</style>

@code {
    [Parameter]
    public string Id { get; set; } = "";

    private Project? _project;
    private List<PullRequest>? _rootPullRequests;
    private List<FlattenedPR> _flattenedCurrentPRs = [];
    private PullRequest? _selectedPullRequest;
    private string? _selectedPullRequestId;
    private bool _isSyncingPRs;
    private bool _isLoadingPastPRs;
    private bool _tokenMissing;
    private string? _syncError;
    private SyncResult? _lastSyncResult;
    private List<PullRequestWithTime>? _pastPRs;
    private List<FutureChangeWithTime>? _futureChanges;
    private int _pastPRsDisplayCount = 10;

    private record FlattenedPR(PullRequest PullRequest, int Level);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _project != null)
        {
            await SyncPullRequestsAsync();
            await LoadPastPRsAsync();
        }
    }

    private async Task LoadData()
    {
        _project = await ProjectService.GetByIdAsync(Id);
        if (_project != null)
        {
            _rootPullRequests = await PullRequestDataService.GetTreeAsync(Id);
            _flattenedCurrentPRs = FlattenPRs(_rootPullRequests ?? []);

            try
            {
                _futureChanges = await RoadmapService.GetFutureChangesAsync(Id);
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to load future changes for project {ProjectId}", Id);
                _futureChanges = [];
            }
        }
    }

    private List<FlattenedPR> FlattenPRs(List<PullRequest> prs, int level = 0)
    {
        var result = new List<FlattenedPR>();
        foreach (var pr in prs.OrderBy(p => p.CreatedAt))
        {
            result.Add(new FlattenedPR(pr, level));
            if (pr.Children.Any())
            {
                result.AddRange(FlattenPRs(pr.Children.ToList(), level + 1));
            }
        }
        return result;
    }

    private async Task LoadPastPRsAsync()
    {
        if (_project == null)
            return;

        var isConfigured = await GitHubService.IsConfiguredAsync(_project.Id);
        if (!isConfigured)
            return;

        _isLoadingPastPRs = true;
        StateHasChanged();

        try
        {
            var mergedPRs = await PullRequestWorkflowService.GetMergedPullRequestsWithTimeAsync(Id);
            var closedPRs = await PullRequestWorkflowService.GetClosedPullRequestsWithTimeAsync(Id);
            _pastPRs = mergedPRs.Concat(closedPRs).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load past PRs for project {ProjectId}", Id);
            _pastPRs = [];
        }
        finally
        {
            _isLoadingPastPRs = false;
            StateHasChanged();
        }
    }

    private void LoadMorePastPRs()
    {
        _pastPRsDisplayCount += 5;
    }

    private async Task SyncPullRequestsAsync()
    {
        if (_project == null || _isSyncingPRs)
            return;

        var hasGitHubConfig = !string.IsNullOrEmpty(_project.GitHubOwner) &&
                              !string.IsNullOrEmpty(_project.GitHubRepo);
        if (!hasGitHubConfig)
            return;

        var isConfigured = await GitHubService.IsConfiguredAsync(_project.Id);
        if (!isConfigured)
        {
            _tokenMissing = true;
            Logger.LogWarning("PR sync skipped for project {ProjectId}: GITHUB_TOKEN not configured", _project.Id);
            StateHasChanged();
            return;
        }

        _isSyncingPRs = true;
        _tokenMissing = false;
        _syncError = null;
        StateHasChanged();

        try
        {
            Logger.LogInformation("Starting automatic PR sync for project {ProjectId} ({Owner}/{Repo})",
                _project.Id, _project.GitHubOwner, _project.GitHubRepo);

            _lastSyncResult = await GitHubService.SyncPullRequestsAsync(_project.Id);

            if (_lastSyncResult.Errors.Count > 0)
            {
                _syncError = string.Join("; ", _lastSyncResult.Errors);
                Logger.LogWarning("PR sync completed with errors for project {ProjectId}: {Errors}",
                    _project.Id, _syncError);
            }
            else
            {
                Logger.LogInformation("PR sync completed for project {ProjectId}: {Imported} imported, {Updated} updated, {Removed} removed",
                    _project.Id, _lastSyncResult.Imported, _lastSyncResult.Updated, _lastSyncResult.Removed);
            }

            await LoadData();
        }
        catch (Exception ex)
        {
            _syncError = ex.Message;
            Logger.LogError(ex, "Failed to sync pull requests for project {ProjectId}", _project.Id);
        }
        finally
        {
            _isSyncingPRs = false;
            StateHasChanged();
        }
    }

    private async Task RefreshData()
    {
        await LoadData();
        if (_selectedPullRequestId != null)
        {
            _selectedPullRequest = await PullRequestDataService.GetByIdAsync(_selectedPullRequestId);
        }
    }

    private async Task SelectPullRequest(string pullRequestId)
    {
        _selectedPullRequestId = pullRequestId;
        _selectedPullRequest = await PullRequestDataService.GetByIdAsync(pullRequestId);
    }

    private int GetTotalCurrentPRCount()
    {
        return _flattenedCurrentPRs.Count;
    }

    private static string GetPastPRStatusColor(PullRequestStatus status) => status switch
    {
        PullRequestStatus.Merged => "status-merged",
        PullRequestStatus.Closed => "status-closed",
        _ => "status-default"
    };

    private static string GetCurrentPRStatusColor(OpenPullRequestStatus status) => status switch
    {
        OpenPullRequestStatus.InDevelopment => "status-in-development",
        OpenPullRequestStatus.ReadyForReview => "status-ready-for-review",
        _ => "status-default"
    };

    private static string GetChangeTypeStatusColor(ChangeType type) => type switch
    {
        ChangeType.Feature => "status-feature",
        ChangeType.Bug => "status-bug",
        ChangeType.Chore => "status-chore",
        ChangeType.Docs => "status-docs",
        ChangeType.Refactor => "status-refactor",
        ChangeType.Test => "status-test",
        _ => "status-default"
    };

    private static string? GetPastPRSubtitle(PullRequestInfo pr)
    {
        var parts = new List<string>();
        
        if (pr.MergedAt.HasValue)
            parts.Add($"Merged {pr.MergedAt.Value:MMM d, yyyy}");
        else if (pr.ClosedAt.HasValue)
            parts.Add($"Closed {pr.ClosedAt.Value:MMM d, yyyy}");
            
        if (!string.IsNullOrEmpty(pr.Group))
            parts.Add(pr.Group);
            
        return parts.Count > 0 ? string.Join(" - ", parts) : null;
    }

    private static string? GetCurrentPRSubtitle(PullRequest pr)
    {
        var parts = new List<string>();
        
        if (!string.IsNullOrEmpty(pr.BranchName))
            parts.Add(pr.BranchName);
            
        return parts.Count > 0 ? string.Join(" - ", parts) : null;
    }

    private static string? GetFutureChangeSubtitle(RoadmapChange change)
    {
        var parts = new List<string>();
        
        if (!string.IsNullOrEmpty(change.Group))
            parts.Add(change.Group);
            
        if (!string.IsNullOrEmpty(change.Description))
            parts.Add(change.Description);
            
        return parts.Count > 0 ? string.Join(" - ", parts) : null;
    }
}
