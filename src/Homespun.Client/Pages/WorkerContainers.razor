@page "/containers"
@implements IAsyncDisposable
@using Microsoft.AspNetCore.SignalR.Client
@using Homespun.Shared.Models.Containers
@inject HttpContainerApiService ContainerApi
@inject IBreadcrumbService BreadcrumbService
@inject NavigationManager NavigationManager
@inject ILogger<WorkerContainers> Logger

<PageTitle>Containers - Homespun</PageTitle>

<h1>Containers</h1>

<p class="text-text-muted mb-4">
    View and manage worker containers running Claude Code agents.
</p>

<div class="worker-containers-page">
    @if (_isLoading)
    {
        <div class="py-5">
            <LoadingSpinner Size="SpinnerSize.Lg" Label="Loading containers..." Centered="true" />
        </div>
    }
    else if (_containers.Count == 0)
    {
        <div class="empty-state">
            <div class="empty-icon">ðŸ“¦</div>
            <h5>No Active Containers</h5>
            <p class="text-text-muted">Worker containers are started automatically when you begin a session for an issue.</p>
        </div>
    }
    else
    {
        @foreach (var group in _groupedContainers)
        {
            <div class="project-group">
                <div class="project-header">
                    <h5>
                        @if (group.ProjectId != "unknown")
                        {
                            <a href="/projects/@group.ProjectId">@group.ProjectName</a>
                        }
                        else
                        {
                            @group.ProjectName
                        }
                    </h5>
                    <span class="badge bg-secondary">@group.Containers.Count container@(group.Containers.Count != 1 ? "s" : "")</span>
                </div>

                <div class="containers-list">
                    @foreach (var container in group.Containers)
                    {
                        <div class="container-card">
                            <div class="container-card-header">
                                <div class="container-title">
                                    <span class="container-name">@GetDisplayTitle(container)</span>
                                </div>
                                <span class="status-indicator @GetStatusIndicatorClass(container.SessionStatus)" title="@container.SessionStatus.ToDisplayLabel()"></span>
                            </div>

                            <div class="container-card-body">
                                <div class="container-details">
                                    <div class="detail-row">
                                        <span class="detail-label">Container:</span>
                                        <span class="detail-value font-mono">@container.ContainerName</span>
                                    </div>

                                    @if (!string.IsNullOrEmpty(container.IssueId))
                                    {
                                        <div class="detail-row">
                                            <span class="detail-label">Issue:</span>
                                            <span class="detail-value">
                                                @if (!string.IsNullOrEmpty(container.ProjectId))
                                                {
                                                    <a href="/projects/@container.ProjectId#issue-@container.IssueId">
                                                        @(container.IssueTitle ?? container.IssueId)
                                                    </a>
                                                }
                                                else
                                                {
                                                    @(container.IssueTitle ?? container.IssueId)
                                                }
                                            </span>
                                        </div>
                                    }

                                    <div class="detail-row">
                                        <span class="detail-label">Status:</span>
                                        <span class="detail-value status-with-badge">
                                            @if (container.HasPendingQuestion)
                                            {
                                                <span class="badge bg-status-question">Question Pending</span>
                                            }
                                            else if (container.HasPendingPlanApproval)
                                            {
                                                <span class="badge bg-status-info">Plan Approval Pending</span>
                                            }
                                            else
                                            {
                                                @container.SessionStatus.ToDisplayLabel()
                                            }
                                        </span>
                                    </div>

                                    @if (container.LastActivityAt.HasValue)
                                    {
                                        <div class="detail-row">
                                            <span class="detail-label">Last Activity:</span>
                                            <span class="detail-value">@FormatTimeAgo(container.LastActivityAt.Value)</span>
                                        </div>
                                    }

                                    <div class="detail-row">
                                        <span class="detail-label">Created:</span>
                                        <span class="detail-value">@FormatTimeAgo(container.CreatedAt)</span>
                                    </div>
                                </div>
                            </div>

                            <div class="container-card-footer">
                                @if (!string.IsNullOrEmpty(container.ActiveSessionId))
                                {
                                    <a href="/session/@container.ActiveSessionId" class="btn btn-sm btn-outline-primary">
                                        Open Session
                                    </a>
                                }

                                <button class="btn btn-sm btn-outline-danger"
                                        @onclick="() => StopContainer(container.ContainerId)"
                                        disabled="@(_stoppingContainers.Contains(container.ContainerId))">
                                    @if (_stoppingContainers.Contains(container.ContainerId))
                                    {
                                        <span class="spinner-border spinner-border-sm mr-1" role="status"></span>
                                    }
                                    Kill Container
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger mt-3">@_errorMessage</div>
    }
</div>

<style>
    .worker-containers-page {
        max-width: 1200px;
    }

    .empty-state {
        text-align: center;
        padding: var(--spacing-xl) var(--spacing-lg);
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: var(--spacing-md);
    }

    .empty-state h5 {
        margin-bottom: var(--spacing-sm);
        color: var(--text-primary);
    }

    .project-group {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
        overflow: hidden;
        margin-bottom: var(--spacing-lg);
    }

    .project-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
    }

    .project-header h5 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
    }

    .project-header h5 a {
        color: var(--text-primary);
        text-decoration: none;
    }

    .project-header h5 a:hover {
        text-decoration: underline;
    }

    .containers-list {
        display: flex;
        flex-direction: column;
    }

    .container-card {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
    }

    .container-card:last-child {
        border-bottom: none;
    }

    .container-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
    }

    .container-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        flex: 1;
        min-width: 0;
    }

    .container-name {
        font-weight: 500;
        font-size: 0.875rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .status-indicator.running {
        background: var(--status-success);
        animation: pulse 1.5s ease-in-out infinite;
    }

    .status-indicator.processing {
        background: var(--status-info);
        animation: pulse 1s ease-in-out infinite;
    }

    .status-indicator.waiting {
        background: var(--status-warning);
    }

    .status-indicator.question {
        background: var(--status-question);
        animation: pulse 1s ease-in-out infinite;
    }

    .status-indicator.stopped {
        background: var(--text-muted);
    }

    .status-indicator.error {
        background: var(--status-error);
    }

    .container-card-body {
        padding: var(--spacing-md);
    }

    .container-details {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
    }

    .detail-row {
        display: flex;
        align-items: baseline;
        gap: var(--spacing-sm);
        font-size: 0.875rem;
    }

    .detail-label {
        color: var(--text-muted);
        font-weight: 500;
        min-width: 100px;
        flex-shrink: 0;
    }

    .detail-value {
        color: var(--text-secondary);
    }

    .detail-value.font-mono {
        font-family: var(--font-mono);
        font-size: 0.8125rem;
    }

    .status-with-badge {
        display: flex;
        align-items: center;
    }

    .container-card-footer {
        display: flex;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--bg-tertiary);
        border-top: 1px solid var(--border-color);
    }
</style>

@code {
    private List<WorkerContainerDto> _containers = [];
    private List<ProjectGroupInfo> _groupedContainers = [];
    private bool _isLoading = true;
    private string? _errorMessage;
    private HashSet<string> _stoppingContainers = [];
    private HubConnection? _hubConnection;

    private class ProjectGroupInfo
    {
        public required string ProjectId { get; set; }
        public required string ProjectName { get; set; }
        public required List<WorkerContainerDto> Containers { get; set; }
    }

    private void GroupContainersByProject()
    {
        _groupedContainers = _containers
            .GroupBy(c => c.ProjectId ?? "unknown")
            .Select(group => new ProjectGroupInfo
            {
                ProjectId = group.Key,
                ProjectName = group.First().ProjectName ?? "Unknown Project",
                Containers = group.OrderBy(c => c.IssueTitle ?? c.IssueId ?? c.ContainerName).ToList()
            })
            .OrderBy(g => g.ProjectName)
            .ToList();
    }

    private static string GetDisplayTitle(WorkerContainerDto container)
    {
        if (!string.IsNullOrEmpty(container.IssueTitle))
            return container.IssueTitle;
        if (!string.IsNullOrEmpty(container.IssueId))
            return container.IssueId;
        return container.ContainerName;
    }

    protected override async Task OnInitializedAsync()
    {
        await BreadcrumbService.SetContextAsync(new BreadcrumbContext { PageName = "Containers" });
        await RefreshContainers();

        // Set up SignalR connection for real-time updates (non-blocking)
        _ = SetupSignalRConnectionAsync();
    }

    private async Task RefreshContainers()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;
            _containers = await ContainerApi.GetAllContainersAsync();
            GroupContainersByProject();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load containers");
            _errorMessage = $"Failed to load containers: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task StopContainer(string containerId)
    {
        _stoppingContainers.Add(containerId);
        _errorMessage = null;

        try
        {
            await ContainerApi.StopContainerAsync(containerId);
            await RefreshContainers();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to stop container {ContainerId}", containerId);
            _errorMessage = $"Failed to stop container: {ex.Message}";
        }
        finally
        {
            _stoppingContainers.Remove(containerId);
        }
    }

    private static string GetStatusIndicatorClass(ClaudeSessionStatus status) => status.ToIndicatorClass();

    private static string FormatTimeAgo(DateTime utcTime)
    {
        var elapsed = DateTime.UtcNow - utcTime;

        if (elapsed.TotalMinutes < 1)
            return "just now";
        if (elapsed.TotalMinutes < 60)
            return $"{(int)elapsed.TotalMinutes}m ago";
        if (elapsed.TotalHours < 24)
            return $"{(int)elapsed.TotalHours}h {elapsed.Minutes}m ago";
        return $"{(int)elapsed.TotalDays}d ago";
    }

    private async Task SetupSignalRConnectionAsync()
    {
        try
        {
            _hubConnection = new HubConnectionBuilder()
                .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/claudecode"))
                .WithAutomaticReconnect()
                .Build();

            // Subscribe to session events to refresh container list
            _hubConnection.On<ClaudeSession>("SessionStarted", async (_) =>
            {
                await InvokeAsync(async () =>
                {
                    await RefreshContainers();
                    StateHasChanged();
                });
            });

            _hubConnection.On<string, ClaudeSessionStatus>("SessionStatusChanged", async (_, _) =>
            {
                await InvokeAsync(async () =>
                {
                    await RefreshContainers();
                    StateHasChanged();
                });
            });

            _hubConnection.On<string>("SessionStopped", async (_) =>
            {
                await InvokeAsync(async () =>
                {
                    await RefreshContainers();
                    StateHasChanged();
                });
            });

            await _hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to set up SignalR connection for WorkerContainers");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            try
            {
                await _hubConnection.DisposeAsync();
            }
            catch
            {
                // Ignore disposal errors
            }
        }
    }
}
