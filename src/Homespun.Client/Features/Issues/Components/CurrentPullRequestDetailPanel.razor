@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable

@inject HttpIssueApiService IssueApi
@inject HttpSessionApiService SessionStoreApi
@inject HttpSessionApiService SessionApi
@inject HttpAgentPromptApiService AgentPromptApi
@inject HttpPullRequestApiService PullRequestApi
@inject HttpPullRequestApiService PullRequestWorkflowApi
@inject HttpProjectApiService ProjectApi
@inject HttpPullRequestApiService GitHubApi
@inject HttpCloneApiService CloneApi
@inject NavigationManager NavigationManager
@inject ILogger<CurrentPullRequestDetailPanel> Logger
@inject IMarkdownRenderingService MarkdownService

<BbCard Class="pull-request-detail-panel">
    <BbCardHeader Class="flex justify-between items-center">
        <BbCardTitle>Pull Request Details</BbCardTitle>
        <button type="button" class="btn-close" @onclick="OnClose"></button>
    </BbCardHeader>
    <BbCardContent>
        <h5>@PullRequest.Title</h5>

        <div class="mb-3">
            <BbBadge Class="@GetStatusBadgeClass()">@PullRequest.Status</BbBadge>
            @if (PullRequest.GitHubPRNumber.HasValue && PullRequest.Project != null)
            {
                <a href="https://github.com/@PullRequest.Project.GitHubOwner/@PullRequest.Project.GitHubRepo/pull/@PullRequest.GitHubPRNumber"
                   target="_blank"
                   style="text-decoration: none;">
                    <BbBadge Variant="BadgeVariant.Secondary" Class="ml-1">
                        PR #@PullRequest.GitHubPRNumber
                    </BbBadge>
                </a>
            }
            @if (_isStarting)
            {
                <BbBadge Class="bg-amber-500 text-white border-transparent ml-1">
                    <BbSpinner Size="SpinnerSize.Small" Class="mr-1" />
                    Starting...
                </BbBadge>
            }
            else if (_session != null)
            {
                <BbBadge Class="bg-green-600 text-white border-transparent ml-1">Session Active</BbBadge>
            }
        </div>

        @if (!string.IsNullOrEmpty(PullRequest.Description))
        {
            <div class="description-content markdown-content mb-3">
                @((MarkupString)MarkdownService.RenderToHtml(PullRequest.Description))
            </div>
        }

        @* Linked Issue Details Section *@
        @if (_linkedIssue != null)
        {
            <div class="border rounded p-2 mb-3 bg-surface-secondary">
                <h6 class="mb-2">
                    <BbBadge Class="bg-blue-500 text-white border-transparent mr-1">@_linkedIssue.Id</BbBadge>
                    Linked Issue
                </h6>
                <p class="mb-1 font-bold">@_linkedIssue.Title</p>
                <div class="mb-1">
                    <BbBadge Class="@GetIssueTypeBadgeClass(_linkedIssue.Type)">@_linkedIssue.Type</BbBadge>
                    <BbBadge Class="@GetIssueStatusBadgeClass(_linkedIssue.Status)">@_linkedIssue.Status</BbBadge>
                    @if (_linkedIssue.Priority.HasValue)
                    {
                        <BbBadge Variant="BadgeVariant.Secondary">P@_linkedIssue.Priority</BbBadge>
                    }
                </div>
                @if (!string.IsNullOrEmpty(_linkedIssue.Description))
                {
                    <p class="mb-0 text-sm text-text-muted">@TruncateDescription(_linkedIssue.Description, 150)</p>
                }
            </div>
        }
        else if (!string.IsNullOrEmpty(PullRequest.BeadsIssueId))
        {
            <div class="border rounded p-2 mb-3 bg-surface-secondary">
                <h6 class="mb-2">
                    <BbBadge Class="bg-blue-500 text-white border-transparent mr-1">@PullRequest.BeadsIssueId</BbBadge>
                    Linked Issue
                    <span class="text-text-muted text-sm">(not found)</span>
                </h6>
            </div>
        }

        <dl class="grid grid-cols-12 text-sm">
            @if (!string.IsNullOrEmpty(PullRequest.BranchName))
            {
                <dt class="col-span-4">Branch</dt>
                <dd class="col-span-8"><code>@PullRequest.BranchName</code></dd>
            }
            @if (!string.IsNullOrEmpty(PullRequest.ClonePath))
            {
                <dt class="col-span-4">Clone</dt>
                <dd class="col-span-8"><code>@PullRequest.ClonePath</code></dd>
            }
            <dt class="col-span-4">Created</dt>
            <dd class="col-span-8">@PullRequest.CreatedAt.ToLocalTime().ToString("g")</dd>
            <dt class="col-span-4">Updated</dt>
            <dd class="col-span-8">@PullRequest.UpdatedAt.ToLocalTime().ToString("g")</dd>
        </dl>

        @* Session Status Display *@
        @if (_session != null)
        {
            <div class="border-top pt-3 mt-3">
                <h6>Claude Code Session</h6>
                <div class="mb-2">
                    <BbBadge Class="@GetSessionStatusBadgeClass()">@_session.Status</BbBadge>
                    <BbButton Variant="ButtonVariant.Outline" Size="ButtonSize.Small" Class="ml-2" Href="@($"/session/{_session.Id}")">
                        Open Chat
                    </BbButton>
                </div>
                <div class="mb-2">
                    <small class="text-text-muted">
                        Mode: <BbBadge Class="@(_session.Mode == SessionMode.Plan ? "bg-blue-500 text-white border-transparent" : "bg-green-600 text-white border-transparent")">@_session.Mode</BbBadge>
                    </small>
                    <br/>
                    <small class="text-text-muted">
                        Model: <code>@GetModelDisplayName(_session.Model)</code>
                    </small>
                </div>
                @if (!string.IsNullOrEmpty(_sessionErrorMessage))
                {
                    <BbAlert Variant="AlertVariant.Danger" Class="mt-2 mb-0">
                        <BbAlertDescription>@_sessionErrorMessage</BbAlertDescription>
                    </BbAlert>
                }
            </div>
        }

        @* Session History *@
        <SessionCacheHistory
            EntityId="@PullRequest.Id"
            ProjectId="@PullRequest.ProjectId"
            WorkingDirectory="@PullRequest.ClonePath"
            ShowBorder="true"
            ShowEmptyState="false" />
    </BbCardContent>
    <BbCardFooter>
        <div class="flex flex-wrap gap-2">
            @* Skip review - only when Ready for Review *@
            @if (PullRequest.Status == OpenPullRequestStatus.ReadyForReview)
            {
                <BbButton Variant="ButtonVariant.Secondary" Size="ButtonSize.Small" OnClick="SkipReview" Disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <BbSpinner Size="SpinnerSize.Small" Class="mr-1" />
                    }
                    Skip Review
                </BbButton>
            }

            @* Start/Stop Session - available for all statuses *@
            @if (_isStarting)
            {
                <BbButton Variant="ButtonVariant.Secondary" Size="ButtonSize.Small" Disabled="true">
                    <BbSpinner Size="SpinnerSize.Small" Class="mr-1" />
                    Starting Session...
                </BbButton>
            }
            else if (_session != null)
            {
                <BbButton Variant="ButtonVariant.Default" Size="ButtonSize.Small" Href="@($"/session/{_session.Id}")">
                    Open Chat
                </BbButton>
                <BbButton Variant="ButtonVariant.Destructive" Size="ButtonSize.Small" OnClick="StopSession" Disabled="@_isSessionLoading">
                    @if (_isSessionLoading)
                    {
                        <BbSpinner Size="SpinnerSize.Small" Class="mr-1" />
                    }
                    Stop Session
                </BbButton>
            }
            else
            {
                <div class="flex flex-col gap-2">
                    <div>
                        <ModelSelector Id="@($"pr-model-{PullRequest.Id}")"
                                       SelectedModel="@_selectedModel"
                                       SelectedModelChanged="OnModelChanged" />
                    </div>
                    <AgentSelector
                        ProjectId="@PullRequest.ProjectId"
                        Disabled="@StartSessionDisabled"
                        IsStarting="@_isStarting"
                        OnStart="HandleAgentStart" />

                    @if (_cloneInfo != null && _branchInfo?.BehindCount > 0)
                    {
                        <BbButton Variant="ButtonVariant.Secondary" Size="ButtonSize.Small" Class="w-full"
                                OnClick="StartRebaseAsync"
                                Disabled="@(_isRebasing || _isStarting)">
                            @if (_isRebasing)
                            {
                                <BbSpinner Size="SpinnerSize.Small" Class="mr-1" />
                            }
                            Rebase onto @_project?.DefaultBranch (@_branchInfo.BehindCount behind)
                        </BbButton>
                    }
                </div>

                @* Show previous sessions that can be resumed *@
                @if (!string.IsNullOrEmpty(PullRequest.ClonePath))
                {
                    <SessionHistoryList
                        EntityId="@PullRequest.Id"
                        ProjectId="@PullRequest.ProjectId"
                        WorkingDirectory="@PullRequest.ClonePath" />
                }
            }

            @* Merge - only when Approved *@
            @if (PullRequest is { Status: OpenPullRequestStatus.Approved, GitHubPRNumber: not null })
            {
                <BbButton Variant="ButtonVariant.Default" Size="ButtonSize.Small" OnClick="MergePullRequest" Disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <BbSpinner Size="SpinnerSize.Small" Class="mr-1" />
                    }
                    Merge
                </BbButton>
            }
        </div>

        @if (!string.IsNullOrEmpty(_startupError))
        {
            <BbAlert Variant="AlertVariant.Danger" Class="mt-2 mb-0" Dismissible OnDismiss="ClearStartupError">
                <BbAlertDescription>@_startupError</BbAlertDescription>
            </BbAlert>
        }
        else if (!string.IsNullOrEmpty(_errorMessage))
        {
            <BbAlert Variant="AlertVariant.Danger" Class="mt-2 mb-0">
                <BbAlertDescription>@_errorMessage</BbAlertDescription>
            </BbAlert>
        }
        else if (!string.IsNullOrEmpty(_sessionErrorMessage))
        {
            <BbAlert Variant="AlertVariant.Danger" Class="mt-2 mb-0">
                <BbAlertDescription>@_sessionErrorMessage</BbAlertDescription>
            </BbAlert>
        }
    </BbCardFooter>
</BbCard>

@code {
    [Parameter] public PullRequest PullRequest { get; set; } = null!;

    [Parameter] public EventCallback OnActionCompleted { get; set; }

    [Parameter] public EventCallback OnClose { get; set; }

    private bool _isLoading;
    private string? _errorMessage;
    private bool _isSessionLoading;
    private string? _sessionErrorMessage;
    private ClaudeSession? _session;
    private string _selectedModel = "opus";
    private Project? _project;
    private CloneInfo? _cloneInfo;
    private BranchInfo? _branchInfo;
    private bool _isRebasing;
    private bool _isStarting;
    private string? _startupError;
    private IssueResponse? _linkedIssue;
    private HubConnection? _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        // Set up SignalR connection for real-time updates (non-blocking)
        _ = SetupSignalRConnectionAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await RefreshSessionStatusAsync();
        await LoadCloneInfoAsync();
        await LoadLinkedIssueAsync();
    }

    private async Task LoadLinkedIssueAsync()
    {
        _linkedIssue = null;

        if (string.IsNullOrEmpty(PullRequest.BeadsIssueId) || _project == null)
            return;

        try
        {
            _linkedIssue = await IssueApi.GetIssueAsync(PullRequest.BeadsIssueId, PullRequest.ProjectId);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load linked issue {IssueId} for PR {PullRequestId}",
                PullRequest.BeadsIssueId, PullRequest.Id);
        }
    }

    private async Task LoadCloneInfoAsync()
    {
        _cloneInfo = null;
        _branchInfo = null;

        // Load project if not already loaded from PullRequest
        _project = PullRequest.Project ?? await ProjectApi.GetProjectAsync(PullRequest.ProjectId);

        if (_project == null || string.IsNullOrEmpty(PullRequest.ClonePath))
            return;

        try
        {
            var clones = await CloneApi.ListClonesAsync(PullRequest.ProjectId);
            _cloneInfo = clones.FirstOrDefault(w => w.Path == PullRequest.ClonePath);

            // BranchInfo is not available via the clone HTTP API; leave _branchInfo null
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load clone info for PR {PullRequestId}", PullRequest.Id);
        }
    }

    private async Task RefreshSessionStatusAsync()
    {
        _session = await SessionStoreApi.GetSessionByEntityIdAsync(PullRequest.Id);
    }

    private void OnModelChanged(string modelId)
    {
        _selectedModel = modelId;
    }

    private async Task HandleAgentStart(AgentPrompt? selectedPrompt)
    {
        await StartSession(selectedPrompt);
    }

    private async Task StartSession(AgentPrompt? prompt)
    {
        if (_isStarting) return;
        _isStarting = true;
        _sessionErrorMessage = null;
        _startupError = null;
        StateHasChanged();

        try
        {
            var clonePath = PullRequest.ClonePath;

            // If no clone path, try to create one from the branch
            if (string.IsNullOrEmpty(clonePath) && !string.IsNullOrEmpty(PullRequest.BranchName) && PullRequest.Project != null)
            {
                Logger.LogInformation("No clone path for PR, checking if branch {BranchName} has a clone", PullRequest.BranchName);

                // Check if clone already exists for this branch
                var cloneExistsResult = await CloneApi.CheckCloneExistsAsync(PullRequest.ProjectId, PullRequest.BranchName);

                if (cloneExistsResult?.Exists == true)
                {
                    // Find the clone path from the clones list
                    var clones = await CloneApi.ListClonesAsync(PullRequest.ProjectId);
                    var existingClone = clones.FirstOrDefault(c =>
                        c.Branch?.Replace("refs/heads/", "") == PullRequest.BranchName);
                    clonePath = existingClone?.Path;

                    if (!string.IsNullOrEmpty(clonePath))
                    {
                        Logger.LogInformation("Found existing clone at {ClonePath}", clonePath);

                        // Pull latest changes
                        Logger.LogInformation("Pulling latest changes to clone {ClonePath}", clonePath);
                        try
                        {
                            await CloneApi.PullCloneAsync(clonePath);
                        }
                        catch
                        {
                            Logger.LogWarning("Failed to pull latest changes, continuing anyway");
                        }
                    }
                }
                else
                {
                    // Create new clone for the PR branch
                    Logger.LogInformation("Creating clone for branch {BranchName}", PullRequest.BranchName);
                    var createResult = await CloneApi.CreateCloneAsync(new CreateCloneRequest
                    {
                        ProjectId = PullRequest.ProjectId,
                        BranchName = PullRequest.BranchName,
                        CreateBranch = false // Branch already exists for PRs
                    });
                    clonePath = createResult?.Path;
                }

                // Update the PR with the clone path
                if (!string.IsNullOrEmpty(clonePath))
                {
                    PullRequest.ClonePath = clonePath;
                    await PullRequestApi.UpdatePullRequestAsync(PullRequest.Id, new UpdatePullRequestRequest
                    {
                        BranchName = PullRequest.BranchName
                    });
                }
            }

            if (string.IsNullOrEmpty(clonePath))
            {
                _sessionErrorMessage = "Unable to create or find clone for this pull request.";
                _startupError = _sessionErrorMessage;
                return;
            }

            // Use the prompt's mode, or default to Build if no prompt selected
            var mode = prompt?.Mode ?? SessionMode.Build;

            var systemPrompt = GenerateSystemPrompt();
            _session = await SessionApi.CreateSessionAsync(new CreateSessionRequest
            {
                EntityId = PullRequest.Id,
                ProjectId = PullRequest.ProjectId,
                WorkingDirectory = clonePath,
                Mode = mode,
                Model = _selectedModel,
                SystemPrompt = systemPrompt
            });

            // Send an initial message to start the agent working (if a prompt is selected)
            if (_session != null && prompt != null && !string.IsNullOrEmpty(prompt.InitialMessage))
            {
                // Template rendering is server-side only; send the raw initial message
                await SessionApi.SendMessageAsync(_session.Id, new SendMessageRequest
                {
                    Message = prompt.InitialMessage
                });
            }

            // Agent started - user stays on current page and can monitor via status indicator
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to start session for PR {PullRequestId}", PullRequest.Id);
            _sessionErrorMessage = $"Failed to start session: {ex.Message}";
            _startupError = _sessionErrorMessage;
            _session = null;
        }
        finally
        {
            _isStarting = false;
            StateHasChanged();
        }
    }

    private string? GenerateSystemPrompt()
    {
        // Build a context-aware system prompt based on the pull request
        var sb = new System.Text.StringBuilder();
        sb.AppendLine($"You are working on PR: {PullRequest.Title}");

        if (!string.IsNullOrEmpty(PullRequest.Description))
        {
            sb.AppendLine();
            sb.AppendLine("PR Description:");
            sb.AppendLine(PullRequest.Description);
        }

        if (!string.IsNullOrEmpty(PullRequest.BranchName))
        {
            sb.AppendLine();
            sb.AppendLine($"Branch: {PullRequest.BranchName}");
        }

        // Include full linked issue details if available
        if (_linkedIssue != null)
        {
            sb.AppendLine();
            sb.AppendLine($"Linked Issue: {_linkedIssue.Id}");
            sb.AppendLine($"Issue Title: {_linkedIssue.Title}");
            sb.AppendLine($"Issue Type: {_linkedIssue.Type}");
            sb.AppendLine($"Issue Status: {_linkedIssue.Status}");
            if (_linkedIssue.Priority.HasValue)
            {
                sb.AppendLine($"Issue Priority: {_linkedIssue.Priority}");
            }
            if (!string.IsNullOrEmpty(_linkedIssue.Description))
            {
                sb.AppendLine($"Issue Description: {_linkedIssue.Description}");
            }
        }
        else if (!string.IsNullOrEmpty(PullRequest.BeadsIssueId))
        {
            sb.AppendLine();
            sb.AppendLine($"Linked Issue ID: {PullRequest.BeadsIssueId}");
        }

        return sb.ToString();
    }

    private async Task StopSession()
    {
        if (_session == null) return;

        _isSessionLoading = true;
        _sessionErrorMessage = null;
        try
        {
            await SessionApi.StopSessionAsync(_session.Id);
            _session = null;
            await OnActionCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _sessionErrorMessage = ex.Message;
        }
        finally
        {
            _isSessionLoading = false;
        }
    }

    private async Task StartRebaseAsync()
    {
        if (_project == null || _cloneInfo == null || string.IsNullOrEmpty(PullRequest.BranchName))
        {
            _errorMessage = "Project or clone not available.";
            return;
        }

        _isRebasing = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            // Rebase agent is not available in WASM client
            _errorMessage = "Rebase agent is not available in the browser client. Please use the server application.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to start rebase agent for PR {PullRequestId}", PullRequest.Id);
            _errorMessage = $"Failed to start rebase agent: {ex.Message}";
        }
        finally
        {
            _isRebasing = false;
            StateHasChanged();
        }
    }

    private void ClearStartupError()
    {
        _startupError = null;
    }

    // Session can be started if there's a branch name and not already starting
    private bool StartSessionDisabled => string.IsNullOrEmpty(PullRequest.BranchName) || _isStarting;

    private async Task SkipReview()
    {
        _isLoading = true;
        _errorMessage = null;
        try
        {
            // Move back to InDevelopment so session can continue working
            await PullRequestApi.UpdatePullRequestAsync(PullRequest.Id, new UpdatePullRequestRequest
            {
                Status = OpenPullRequestStatus.InDevelopment
            });
            await OnActionCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task MergePullRequest()
    {
        if (!PullRequest.GitHubPRNumber.HasValue)
        {
            _errorMessage = "No GitHub PR linked to this pull request.";
            return;
        }

        _isLoading = true;
        _errorMessage = null;
        try
        {
            // Stop session if running before merge
            if (_session != null)
            {
                await SessionApi.StopSessionAsync(_session.Id);
                _session = null;
            }

            // Merge via PR sync (triggers server-side merge via GitHub API)
            await PullRequestApi.SyncPullRequestsAsync(PullRequest.ProjectId);

            // Remove from local tracking after merge attempt
            await PullRequestApi.DeletePullRequestAsync(PullRequest.Id);
            await OnActionCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetStatusBadgeClass()
    {
        return PullRequest.Status switch
        {
            OpenPullRequestStatus.InDevelopment => "bg-primary text-primary-foreground border-transparent",
            OpenPullRequestStatus.ReadyForReview => "bg-amber-500 text-white border-transparent",
            OpenPullRequestStatus.HasReviewComments => "bg-destructive text-destructive-foreground border-transparent",
            OpenPullRequestStatus.Approved => "bg-green-600 text-white border-transparent",
            _ => "bg-secondary text-secondary-foreground border-transparent"
        };
    }

    private string GetSessionStatusBadgeClass() => _session?.Status.ToBbBadgeClass() ?? "bg-secondary text-secondary-foreground border-transparent";

    private static string GetModelDisplayName(string model)
    {
        var parts = model.Split('/');
        return parts.Length > 1 ? parts[1] : model;
    }

    private static string GetIssueTypeBadgeClass(IssueType type) => type switch
    {
        IssueType.Feature => "bg-primary text-primary-foreground border-transparent",
        IssueType.Bug => "bg-destructive text-destructive-foreground border-transparent",
        IssueType.Task => "bg-blue-500 text-white border-transparent",
        IssueType.Chore => "bg-secondary text-secondary-foreground border-transparent",
        _ => "bg-secondary text-secondary-foreground border-transparent"
    };

    private static string GetIssueStatusBadgeClass(IssueStatus status) => status switch
    {
        IssueStatus.Open => "bg-blue-500 text-white border-transparent",
        IssueStatus.Progress => "bg-primary text-primary-foreground border-transparent",
        IssueStatus.Review => "bg-blue-500 text-white border-transparent",
        IssueStatus.Complete => "bg-green-600 text-white border-transparent",
        IssueStatus.Closed => "bg-green-600 text-white border-transparent",
        _ => "bg-secondary text-secondary-foreground border-transparent"
    };

    private static string TruncateDescription(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
            return text;
        return text[..maxLength].TrimEnd() + "...";
    }

    private async Task SetupSignalRConnectionAsync()
    {
        try
        {
            _hubConnection = new HubConnectionBuilder()
                .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/claudecode"))
                .WithAutomaticReconnect()
                .Build();

            // Subscribe to session started events - update UI when session becomes active
            _hubConnection.On<ClaudeSession>("SessionStarted", async (session) =>
            {
                // Only handle events for this specific PR
                if (session.EntityId == PullRequest.Id)
                {
                    await InvokeAsync(() =>
                    {
                        _session = session;
                        _isStarting = false;
                        StateHasChanged();
                    });
                }
            });

            // Subscribe to session status changes - refresh session data
            _hubConnection.On<string, ClaudeSessionStatus, bool>("SessionStatusChanged", async (sessionId, status, _) =>
            {
                // Refresh if the changed session is ours
                if (_session?.Id == sessionId)
                {
                    await InvokeAsync(async () =>
                    {
                        _session = await SessionStoreApi.GetSessionByEntityIdAsync(PullRequest.Id);
                        StateHasChanged();
                    });
                }
            });

            // Subscribe to session stopped events - clear the session
            _hubConnection.On<string>("SessionStopped", async (sessionId) =>
            {
                // Clear session if it was ours
                if (_session?.Id == sessionId)
                {
                    await InvokeAsync(() =>
                    {
                        _session = null;
                        StateHasChanged();
                    });
                }
            });

            await _hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to set up SignalR connection for CurrentPullRequestDetailPanel");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            try
            {
                await _hubConnection.DisposeAsync();
            }
            catch
            {
                // Ignore disposal errors
            }
        }
    }
}
