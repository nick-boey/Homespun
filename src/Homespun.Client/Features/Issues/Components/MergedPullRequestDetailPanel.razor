@inject NavigationManager NavigationManager
@inject IMarkdownRenderingService MarkdownService

<BbCard Class="merged-pull-request-detail-panel">
    <BbCardHeader Class="flex justify-between items-center">
        <BbCardTitle>Merged Pull Request</BbCardTitle>
        <button type="button" class="btn-close" @onclick="OnClose"></button>
    </BbCardHeader>
    <BbCardContent>
        <h5>@Details.PullRequest.Title</h5>

        <div class="mb-3">
            <BbBadge Class="bg-purple-500 text-white border-transparent">Merged</BbBadge>
            @if (!string.IsNullOrEmpty(Details.PullRequest.HtmlUrl))
            {
                <a href="@Details.PullRequest.HtmlUrl"
                   target="_blank"
                   style="text-decoration: none;">
                    <BbBadge Variant="BadgeVariant.Secondary" Class="ml-1">
                        PR #@Details.PullRequest.Number
                    </BbBadge>
                </a>
            }
        </div>

        @if (!string.IsNullOrEmpty(Details.PullRequest.Body))
        {
            <div class="description-content markdown-content mb-3">
                @((MarkupString)MarkdownService.RenderToHtml(Details.PullRequest.Body))
            </div>
        }

        @* Linked Issue Section *@
        @if (Details.LinkedIssue != null)
        {
            <div class="border rounded p-2 mb-3 bg-surface-secondary">
                <div class="flex justify-between items-start">
                    <h6 class="mb-2">
                        <BbBadge Class="bg-blue-500 text-white border-transparent mr-1">@Details.LinkedIssue.Id</BbBadge>
                        Linked Issue
                    </h6>
                    <BbButton Variant="ButtonVariant.Outline" Size="ButtonSize.Small" Href="@($"/projects/{ProjectId}/issues/{Details.LinkedIssue.Id}/edit")">
                        Edit
                    </BbButton>
                </div>
                <p class="mb-1 font-bold">@Details.LinkedIssue.Title</p>
                <div class="mb-1">
                    <BbBadge Class="@GetIssueTypeBadgeClass(Details.LinkedIssue.Type)">@Details.LinkedIssue.Type</BbBadge>
                    <BbBadge Class="@GetIssueStatusBadgeClass(Details.LinkedIssue.Status)">@Details.LinkedIssue.Status</BbBadge>
                    @if (Details.LinkedIssue.Priority.HasValue)
                    {
                        <BbBadge Variant="BadgeVariant.Secondary">P@Details.LinkedIssue.Priority</BbBadge>
                    }
                </div>
                @if (!string.IsNullOrEmpty(Details.LinkedIssue.Description))
                {
                    <p class="mb-0 text-sm text-text-muted">@TruncateDescription(Details.LinkedIssue.Description, 150)</p>
                }
            </div>
        }
        else if (!string.IsNullOrEmpty(Details.LinkedIssueId))
        {
            <div class="border rounded p-2 mb-3 bg-surface-secondary">
                <h6 class="mb-2">
                    <BbBadge Class="bg-blue-500 text-white border-transparent mr-1">@Details.LinkedIssueId</BbBadge>
                    Linked Issue
                    <span class="text-text-muted text-sm">(not found)</span>
                </h6>
            </div>
        }

        <dl class="grid grid-cols-12 text-sm">
            @if (!string.IsNullOrEmpty(Details.PullRequest.BranchName))
            {
                <dt class="col-span-4">Branch</dt>
                <dd class="col-span-8"><code>@Details.PullRequest.BranchName</code></dd>
            }
            @if (Details.PullRequest.MergedAt.HasValue)
            {
                <dt class="col-span-4">Merged</dt>
                <dd class="col-span-8">@Details.PullRequest.MergedAt.Value.ToLocalTime().ToString("g")</dd>
            }
            <dt class="col-span-4">Created</dt>
            <dd class="col-span-8">@Details.PullRequest.CreatedAt.ToLocalTime().ToString("g")</dd>
        </dl>
    </BbCardContent>
</BbCard>

@code {
    [Parameter, EditorRequired]
    public required MergedPullRequestDetails Details { get; set; }

    [Parameter, EditorRequired]
    public required string ProjectId { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private static string TruncateDescription(string description, int maxLength)
    {
        if (string.IsNullOrEmpty(description) || description.Length <= maxLength)
            return description;
        return description[..maxLength] + "...";
    }

    private static string GetIssueTypeBadgeClass(IssueType type) => type switch
    {
        IssueType.Bug => "bg-destructive text-destructive-foreground border-transparent",
        IssueType.Feature => "bg-primary text-primary-foreground border-transparent",
        IssueType.Chore => "bg-secondary text-secondary-foreground border-transparent",
        IssueType.Task => "bg-blue-500 text-white border-transparent",
        _ => "bg-secondary text-secondary-foreground border-transparent"
    };

    private static string GetIssueStatusBadgeClass(IssueStatus status) => status switch
    {
        IssueStatus.Open => "bg-blue-500 text-white border-transparent",
        IssueStatus.Progress => "bg-primary text-primary-foreground border-transparent",
        IssueStatus.Review => "bg-amber-500 text-white border-transparent",
        IssueStatus.Complete => "bg-green-600 text-white border-transparent",
        IssueStatus.Closed => "bg-secondary text-secondary-foreground border-transparent",
        IssueStatus.Archived => "bg-secondary text-secondary-foreground border-transparent",
        _ => "bg-secondary text-secondary-foreground border-transparent"
    };
}
