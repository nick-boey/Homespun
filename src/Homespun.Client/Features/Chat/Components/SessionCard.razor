@using static Homespun.Client.Features.Chat.Components.SessionsPanel

<div class="session-card">
    <div class="session-card-header">
        <div class="session-title">
            @if (EntityInfo != null)
            {
                <span class="entity-type-badge @GetEntityTypeBadgeClass(EntityInfo.EntityType)">
                    @EntityInfo.EntityType
                </span>
                <span class="entity-title">@EntityInfo.Title</span>
            }
            else
            {
                <span class="text-text-muted">@Session.EntityId</span>
            }
        </div>
        <span class="status-indicator @Session.Status.ToIndicatorClass()" title="@Session.Status.ToDisplayLabel()"></span>
    </div>

    <div class="session-card-body">
        <div class="session-details">
            <div class="detail-row">
                <span class="detail-label">Mode:</span>
                <BbBadge Class="@(Session.Mode == SessionMode.Plan ? "bg-blue-500 text-white border-transparent" : "bg-green-600 text-white border-transparent")">
                    @Session.Mode
                </BbBadge>
            </div>

            <div class="detail-row">
                <span class="detail-label">Model:</span>
                <code class="detail-value">@GetModelDisplayName(Session.Model)</code>
            </div>

            <div class="detail-row">
                <span class="detail-label">Status:</span>
                <BbBadge Class="@Session.Status.ToBbBadgeClass()">@Session.Status.ToDisplayLabel()</BbBadge>
            </div>

            <div class="detail-row">
                <span class="detail-label">Started:</span>
                <span class="detail-value" title="@Session.CreatedAt.ToString("O")">@FormatUptime(DateTime.UtcNow - Session.CreatedAt) ago</span>
            </div>

            <div class="detail-row">
                <span class="detail-label">Last Active:</span>
                <span class="detail-value" title="@Session.LastActivityAt.ToString("O")">@FormatUptime(DateTime.UtcNow - Session.LastActivityAt) ago</span>
            </div>

            <div class="detail-row">
                <span class="detail-label">Messages:</span>
                <span class="detail-value">@Session.MessageCount</span>
            </div>

            @if (!string.IsNullOrEmpty(Session.ContainerId))
            {
                <div class="detail-row">
                    <span class="detail-label">Container:</span>
                    <code class="detail-value container-id" title="@Session.ContainerId">@FormatContainerId(Session.ContainerId)</code>
                </div>
            }
        </div>
    </div>

    <div class="session-card-footer">
        <BbButton Variant="ButtonVariant.Outline" Size="ButtonSize.Small" Href="@($"/session/{Session.Id}")">
            <LucideIcon Name="message-circle" Size="14" Class="me-1" />Chat
        </BbButton>

        <BbButton Variant="ButtonVariant.Destructive" Size="ButtonSize.Small"
                OnClick="OnStop"
                Disabled="@IsStopping">
            @if (IsStopping)
            {
                <BbSpinner Size="SpinnerSize.Small" Class="me-1" />
            }
            <LucideIcon Name="stop-circle" Size="14" Class="me-1" />Stop
        </BbButton>
    </div>
</div>

<style>
    .session-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-md);
        overflow: hidden;
    }

    .session-card:last-child {
        margin-bottom: 0;
    }

    .session-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
    }

    .session-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        flex: 1;
        min-width: 0;
    }

    .entity-type-badge {
        padding: 0.125rem 0.5rem;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        flex-shrink: 0;
    }

    .entity-type-badge.pr {
        background: var(--status-info);
        color: white;
    }

    .entity-type-badge.issue {
        background: var(--status-warning);
        color: white;
    }

    .entity-title {
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .status-indicator.running {
        background: var(--status-success);
        animation: pulse 1.5s ease-in-out infinite;
    }

    .status-indicator.processing {
        background: var(--status-info);
        animation: pulse 1s ease-in-out infinite;
    }

    .status-indicator.waiting {
        background: var(--status-warning);
    }

    .status-indicator.question {
        background: var(--status-question);
        animation: pulse 1s ease-in-out infinite;
    }

    .status-indicator.plan-ready {
        background: var(--status-question);
        animation: pulse 1s ease-in-out infinite;
    }

    .status-indicator.starting {
        background: var(--status-warning);
        animation: pulse 1s ease-in-out infinite;
    }

    .status-indicator.running-hooks {
        background: var(--status-warning);
        animation: pulse 1s ease-in-out infinite;
    }

    .status-indicator.stopped {
        background: var(--text-muted);
    }

    .status-indicator.error {
        background: var(--status-error);
    }

    .session-card-body {
        padding: var(--spacing-md);
    }

    .session-details {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
    }

    .detail-row {
        display: flex;
        align-items: baseline;
        gap: var(--spacing-sm);
        font-size: 0.875rem;
    }

    .detail-label {
        color: var(--text-muted);
        font-weight: 500;
        min-width: 85px;
        flex-shrink: 0;
    }

    .detail-value {
        color: var(--text-secondary);
    }

    .detail-value code {
        font-size: 0.8125rem;
        color: var(--text-primary);
    }

    .detail-value code.container-id {
        font-family: var(--font-mono);
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .session-card-footer {
        display: flex;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--bg-secondary);
        border-top: 1px solid var(--border-color);
    }
</style>

@code {
    [Parameter, EditorRequired] public required SessionSummary Session { get; set; }
    [Parameter] public EntityInfo? EntityInfo { get; set; }
    [Parameter] public bool IsStopping { get; set; }
    [Parameter] public EventCallback OnStop { get; set; }

    private static string GetEntityTypeBadgeClass(string entityType) => entityType.ToLowerInvariant() switch
    {
        "pr" => "pr",
        "issue" => "issue",
        _ => "pr"
    };

    private static string GetModelDisplayName(string model)
    {
        var parts = model.Split('/');
        return parts.Length > 1 ? parts[1] : model;
    }

    private static string FormatUptime(TimeSpan uptime)
    {
        if (uptime.TotalDays >= 1)
            return $"{(int)uptime.TotalDays}d {uptime.Hours}h";
        if (uptime.TotalHours >= 1)
            return $"{(int)uptime.TotalHours}h {uptime.Minutes}m";
        if (uptime.TotalMinutes >= 1)
            return $"{(int)uptime.TotalMinutes}m {uptime.Seconds}s";
        return $"{uptime.Seconds}s";
    }

    private static string FormatContainerId(string containerId)
    {
        return containerId.Length > 12 ? containerId[..12] : containerId;
    }
}
