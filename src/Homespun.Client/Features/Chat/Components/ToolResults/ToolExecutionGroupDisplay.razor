
<div class="tool-group">
    <div class="tool-group-header">
        <span class="tool-group-icon">ðŸ”§</span>
        <span class="tool-group-title">
            @if (Group.Executions.Count == 1)
            {
                @:1 tool call
            }
            else
            {
                @Group.Executions.Count @:tool calls
            }
        </span>
        <span class="ml-auto flex items-center gap-2">
            @if (Group.Executions.Any(e => e.IsRunning))
            {
                <span class="tool-group-streaming">
                    <BbSpinner Size="SpinnerSize.Small" />
                </span>
            }
            @if (Group.Executions.Count > 2)
            {
                <button class="tool-group-toggle" @onclick="ToggleShowAll" @onclick:stopPropagation="true"
                        title="@(_showAll ? "Show fewer" : "Show all")">
                    @(_showAll ? "âˆ’" : "+")
                </button>
            }
        </span>
    </div>
    <div class="tool-execution-list">
        @{
            var executions = GetVisibleExecutions();
            var hiddenCount = Group.Executions.Count - executions.Count;
        }

        @if (hiddenCount > 0)
        {
            <div class="hidden-tools-notice">
                @hiddenCount earlier tool call@(hiddenCount == 1 ? "" : "s") hidden
            </div>
        }

        @foreach (var execution in executions)
        {
            <div class="tool-execution-row @(execution.IsRunning ? "running" : "") @(execution.ToolResult?.ToolSuccess == false ? "error" : "")">
                @if (execution.ToolResult != null)
                {
                    @* Has result - render using ToolResultRenderer which has its own details/summary *@
                    <ToolResultRenderer Result="execution.ToolResult" />
                }
                else
                {
                    @* No result yet - show running indicator *@
                    <div class="tool-result-block">
                        <div class="tool-result-summary running-summary">
                            <span class="tool-icon">@GetToolIcon(execution.ToolUse.ToolName ?? "Tool")</span>
                            <span class="tool-name">@(execution.ToolUse.ToolName ?? "Tool")</span>
                            <span class="tool-summary">
                                <BbSpinner Size="SpinnerSize.Small" />
                                Running...
                            </span>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

<style>
    .tool-group {
        border: 1px solid var(--border-color-light);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .tool-group-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color-light);
        font-size: 0.8125rem;
    }

    .tool-group-icon {
        flex-shrink: 0;
    }

    .tool-group-title {
        font-weight: 600;
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .tool-group-streaming {
        display: flex;
        align-items: center;
    }

    .tool-group-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 1.25rem;
        height: 1.25rem;
        border: 1px solid var(--border-color-light);
        border-radius: var(--radius-sm);
        background: var(--bg-primary);
        color: var(--text-muted);
        cursor: pointer;
        font-size: 0.875rem;
        line-height: 1;
    }

    .tool-group-toggle:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .tool-execution-list {
        display: flex;
        flex-direction: column;
    }

    .tool-execution-row {
        border-bottom: 1px solid var(--border-color-light);
    }

    .tool-execution-row:last-child {
        border-bottom: none;
    }

    .tool-execution-row.error {
        border-left: 3px solid #ef4444;
    }

    .running-summary {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: 0.8125rem;
    }

    .hidden-tools-notice {
        padding: var(--spacing-xs) var(--spacing-md);
        font-size: 0.75rem;
        color: var(--text-muted);
        text-align: center;
        font-style: italic;
        border-bottom: 1px solid var(--border-color-light);
    }
</style>

@code {
    [Parameter]
    public required ToolExecutionGroup Group { get; set; }

    private bool _showAll = false;

    private List<ToolExecution> GetVisibleExecutions()
    {
        if (_showAll || Group.Executions.Count <= 2)
            return Group.Executions;

        // Show the last 2 (most recent)
        return Group.Executions.Skip(Group.Executions.Count - 2).ToList();
    }

    private void ToggleShowAll()
    {
        _showAll = !_showAll;
    }

    private static string GetToolIcon(string toolName) => toolName.ToLowerInvariant() switch
    {
        "read" => "ðŸ“–",
        "write" => "âœï¸",
        "edit" => "ðŸ“",
        "bash" => "ðŸ’»",
        "task" => "ðŸ¤–",
        "explore" => "ðŸ”­",
        "grep" => "ðŸ”",
        "glob" => "ðŸ“",
        "webfetch" => "ðŸŒ",
        "websearch" => "ðŸ”Ž",
        _ => "ðŸ”§"
    };
}
