@inject HttpSecretsApiService SecretsApi

<div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Project Secrets</h5>
    <BbButton Variant="ButtonVariant.Default" Size="ButtonSize.Small" OnClick="ShowAddModal">
        <LucideIcon Name="plus" Size="14" Class="me-1" />
        Add Secret
    </BbButton>
</div>

<BbAlert Variant="AlertVariant.Warning">
    <BbAlertTitle>Security Note</BbAlertTitle>
    <BbAlertDescription>Secrets are stored in a secrets.env file in your project folder. This file is not encrypted. Do not commit this file to source control.</BbAlertDescription>
</BbAlert>

<p class="text-muted small mb-3">
    Environment variables configured here will be injected into worker containers when agents start on this project.
</p>

@if (_isLoading)
{
    <div class="flex items-center gap-2">
        <BbSpinner />
        <span>Loading secrets...</span>
    </div>
}
else if (!_secrets.Any())
{
    <BbEmpty Title="No Secrets Configured" Description="Add environment variables that will be injected into worker containers for this project.">
        <Icon>
            <LucideIcon Name="lock" Size="48" />
        </Icon>
        <ChildContent>
            <BbButton OnClick="ShowAddModal">Add Secret</BbButton>
        </ChildContent>
    </BbEmpty>
}
else
{
    <div class="table-responsive">
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Value</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var secret in _secrets)
                {
                    <tr>
                        <td><code>@secret.Name</code></td>
                        <td><span class="text-muted">********</span></td>
                        <td class="text-end">
                            <BbButton Variant="ButtonVariant.Outline" Size="ButtonSize.Small" Class="me-1" OnClick="() => ShowEditModal(secret)">
                                Edit
                            </BbButton>
                            <BbButton Variant="ButtonVariant.Destructive" Size="ButtonSize.Small" OnClick="() => ShowDeleteConfirmation(secret)">
                                Delete
                            </BbButton>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<BbDialog Open="@_showModal" OnOpenChange="v => { if (!v) HideModal(); }">
    <BbDialogContent>
        <BbDialogHeader>
            <BbDialogTitle>@(_editingSecret == null ? "Add Secret" : "Edit Secret")</BbDialogTitle>
        </BbDialogHeader>
        <BbDialogBody>
            <div class="mb-3">
                <label class="form-label">Name</label>
                <input type="text"
                       class="form-control font-monospace"
                       @bind="_modalName"
                       placeholder="e.g., API_KEY, DATABASE_URL"
                       disabled="@(_editingSecret != null)" />
                <div class="form-text">
                    Must start with a letter or underscore, followed by letters, digits, or underscores only.
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Value</label>
                <input type="password"
                       class="form-control font-monospace"
                       @bind="_modalValue"
                       placeholder="Secret value..." />
                <div class="form-text">
                    @if (_editingSecret != null)
                    {
                        <text>Enter the new value. Leave empty to keep the existing value.</text>
                    }
                    else
                    {
                        <text>The value will be stored in the project's <code>secrets.env</code> file.</text>
                    }
                </div>
            </div>
        </BbDialogBody>
        <BbDialogFooter>
            @if (!string.IsNullOrEmpty(_modalError))
            {
                <div class="text-danger me-auto">@_modalError</div>
            }
            <BbButton Variant="ButtonVariant.Secondary" OnClick="HideModal">Cancel</BbButton>
            <BbButton OnClick="SaveSecret" Loading="@_isSaving" LoadingText="Saving...">Save</BbButton>
        </BbDialogFooter>
    </BbDialogContent>
</BbDialog>

<BbAlertDialog Open="@(_showDeleteConfirmation && _secretToDelete != null)" OnOpenChange="v => { if (!v) HideDeleteConfirmation(); }">
    <BbAlertDialogContent>
        <BbAlertDialogHeader>
            <BbAlertDialogTitle>Delete Secret</BbAlertDialogTitle>
            <BbAlertDialogDescription>
                Are you sure you want to delete the secret <strong><code>@_secretToDelete?.Name</code></strong>?
                This action cannot be undone. Any containers using this secret will no longer have access to it.
            </BbAlertDialogDescription>
        </BbAlertDialogHeader>
        <BbAlertDialogFooter>
            <BbAlertDialogCancel>
                <BbButton Variant="ButtonVariant.Outline" Disabled="@_isDeleting">Cancel</BbButton>
            </BbAlertDialogCancel>
            <BbButton Variant="ButtonVariant.Destructive" OnClick="DeleteSecret" Loading="@_isDeleting">Delete</BbButton>
        </BbAlertDialogFooter>
    </BbAlertDialogContent>
</BbAlertDialog>

@code {
    [Parameter] public required string ProjectId { get; set; }

    private IReadOnlyList<SecretInfo> _secrets = [];
    private bool _isLoading = true;
    private bool _showModal;
    private bool _showDeleteConfirmation;
    private bool _isSaving;
    private bool _isDeleting;
    private string? _modalError;
    private SecretInfo? _editingSecret;
    private SecretInfo? _secretToDelete;

    // Modal form fields
    private string _modalName = string.Empty;
    private string _modalValue = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await RefreshSecrets();
    }

    private async Task RefreshSecrets()
    {
        _isLoading = true;
        try
        {
            _secrets = await SecretsApi.GetSecretsAsync(ProjectId);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ShowAddModal()
    {
        _editingSecret = null;
        _modalName = string.Empty;
        _modalValue = string.Empty;
        _modalError = null;
        _showModal = true;
    }

    private void ShowEditModal(SecretInfo secret)
    {
        _editingSecret = secret;
        _modalName = secret.Name;
        _modalValue = string.Empty; // Don't show the actual value
        _modalError = null;
        _showModal = true;
    }

    private void HideModal()
    {
        _showModal = false;
        _editingSecret = null;
        _modalError = null;
    }

    private async Task SaveSecret()
    {
        if (string.IsNullOrWhiteSpace(_modalName))
        {
            _modalError = "Name is required.";
            return;
        }

        if (_editingSecret == null && string.IsNullOrWhiteSpace(_modalValue))
        {
            _modalError = "Value is required.";
            return;
        }

        _isSaving = true;
        _modalError = null;

        try
        {
            if (_editingSecret == null)
            {
                await SecretsApi.CreateSecretAsync(ProjectId, _modalName.Trim(), _modalValue);
            }
            else if (!string.IsNullOrWhiteSpace(_modalValue))
            {
                await SecretsApi.UpdateSecretAsync(ProjectId, _modalName, _modalValue);
            }
            else
            {
                // No value change, just close the modal
                HideModal();
                return;
            }

            await RefreshSecrets();
            HideModal();
        }
        catch (HttpRequestException ex)
        {
            _modalError = ex.Message.Contains("400")
                ? "Invalid secret name. Use only letters, digits, and underscores, starting with a letter or underscore."
                : ex.Message;
        }
        catch (Exception ex)
        {
            _modalError = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void ShowDeleteConfirmation(SecretInfo secret)
    {
        _secretToDelete = secret;
        _showDeleteConfirmation = true;
    }

    private void HideDeleteConfirmation()
    {
        _showDeleteConfirmation = false;
        _secretToDelete = null;
    }

    private async Task DeleteSecret()
    {
        if (_secretToDelete == null) return;

        _isDeleting = true;
        try
        {
            await SecretsApi.DeleteSecretAsync(ProjectId, _secretToDelete.Name);
            await RefreshSecrets();
            HideDeleteConfirmation();
        }
        finally
        {
            _isDeleting = false;
        }
    }
}
