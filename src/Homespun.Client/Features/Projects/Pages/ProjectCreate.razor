@page "/projects/create"
@inject HttpProjectApiService ProjectApi
@inject IBreadcrumbService BreadcrumbService
@inject NavigationManager Navigation
@inject ILogger<ProjectCreate> Logger

<PageTitle>New Project</PageTitle>

<h1>New Project</h1>

<BbTabs @bind-Value="_mode" ActivationMode="BlazorBlueprint.Primitives.Tabs.TabsActivationMode.Manual" Class="mb-3">
    <BbTabsList>
        <BbTabsTrigger Value="github">GitHub Repository</BbTabsTrigger>
        <BbTabsTrigger Value="local">Local Repository</BbTabsTrigger>
    </BbTabsList>
</BbTabs>

<form @onsubmit="HandleSubmit">
    @if (_mode == "github")
    {
        <div class="mb-3">
            <BbLabel For="ownerRepo">GitHub Repository</BbLabel>
            <BbInput Id="ownerRepo" @bind-Value="_ownerRepo" Required="true"
                     Placeholder="owner/repository" />
            <div class="form-text">
                Enter the GitHub repository in owner/repository format (e.g., microsoft/vscode).
                The repository will be cloned to ~/.homespun/src/&lt;repository&gt;/&lt;default-branch&gt;.
            </div>
        </div>
    }
    else
    {
        <div class="mb-3">
            <BbLabel For="projectName">Project Name</BbLabel>
            <BbInput Id="projectName" @bind-Value="_projectName" Required="true"
                     Placeholder="my-project" />
            <div class="form-text">
                Use only letters, numbers, hyphens, and underscores.
                A new git repository will be created at ~/.homespun/src/&lt;name&gt;/&lt;branch&gt;.
            </div>
        </div>
        <div class="mb-3">
            <BbLabel For="defaultBranch">Default Branch</BbLabel>
            <BbInput Id="defaultBranch" @bind-Value="_defaultBranch"
                     Placeholder="main" />
            <div class="form-text">
                Leave blank to use "main" as the default branch.
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <BbAlert Variant="AlertVariant.Danger">
            <BbAlertDescription>@_errorMessage</BbAlertDescription>
        </BbAlert>
    }

    <BbButton Type="ButtonType.Submit" Loading="@_isSubmitting" LoadingText="Creating...">Create</BbButton>
    <BbButton Variant="ButtonVariant.Secondary" Href="projects">Cancel</BbButton>
</form>

@code {
    private string _mode = "github";
    private string _ownerRepo = "";
    private string _projectName = "";
    private string _defaultBranch = "main";
    private string? _errorMessage;
    private bool _isSubmitting;

    protected override async Task OnInitializedAsync()
    {
        await BreadcrumbService.SetContextAsync(new BreadcrumbContext { PageName = "New Project" });
    }

    private async Task HandleSubmit()
    {
        Logger.LogInformation("HandleSubmit called: mode={Mode}, ownerRepo={OwnerRepo}, projectName={ProjectName}", 
            _mode, _ownerRepo, _projectName);
        
        _errorMessage = null;
        _isSubmitting = true;

        try
        {
            Project? created;

            if (_mode == "github")
            {
                Logger.LogInformation("Creating GitHub project from {OwnerRepo}", _ownerRepo);
                created = await ProjectApi.CreateProjectAsync(new CreateProjectRequest
                {
                    OwnerRepo = _ownerRepo
                });
            }
            else
            {
                var branch = string.IsNullOrWhiteSpace(_defaultBranch) ? "main" : _defaultBranch.Trim();
                Logger.LogInformation("Creating local project {ProjectName} with branch {Branch}", _projectName, branch);
                created = await ProjectApi.CreateProjectAsync(new CreateProjectRequest
                {
                    Name = _projectName.Trim(),
                    DefaultBranch = branch
                });
            }

            if (created != null)
            {
                Logger.LogInformation("Project created successfully, navigating to projects list");
                Navigation.NavigateTo("projects");
            }
            else
            {
                Logger.LogWarning("Project creation returned null");
                _errorMessage = "Failed to create project.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Exception in HandleSubmit");
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
            Logger.LogInformation("HandleSubmit completed, isSubmitting={IsSubmitting}", _isSubmitting);
        }
    }
}
