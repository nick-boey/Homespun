@page "/projects/{Id}/edit"
@inject HttpProjectApiService ProjectApi
@inject IBreadcrumbService BreadcrumbService
@inject NavigationManager Navigation

<PageTitle>Edit Project</PageTitle>

<h1>Edit Project</h1>

@if (_loading)
{
    <p>Loading...</p>
}
else if (_notFound)
{
    <p>Project not found.</p>
    <a href="projects">Back to Projects</a>
}
else
{
    <form @onsubmit="HandleSubmit">
        <div class="grid grid-cols-12">
            <div class="col-span-6">
                <h5>Project Information</h5>

                <div class="mb-3">
                    <BbLabel>Repository</BbLabel>
                    <p class="form-control-plaintext">@_gitHubOwner/@_gitHubRepo</p>
                </div>

                <div class="mb-3">
                    <BbLabel>Default Branch</BbLabel>
                    <p class="form-control-plaintext">@_defaultBranch</p>
                </div>

                <div class="mb-3">
                    <BbLabel>Local Path</BbLabel>
                    <p class="form-control-plaintext text-text-muted" style="font-size: 0.9em;">@_localPath</p>
                </div>
            </div>

            <div class="col-span-6">
                <h5>Agent Settings</h5>
                <p class="text-text-muted text-sm">Configure the default settings for Claude Code sessions in this project.</p>

                <div class="mb-3">
                    <BbLabel For="defaultModel">Default Model</BbLabel>
                    <BbInput Id="defaultModel" @bind-Value="_defaultModel"
                             Placeholder="sonnet" />
                    <div class="form-text">
                        Model identifier (e.g., <code>opus</code>, <code>sonnet</code>, <code>haiku</code>).
                        Leave empty to use global default.
                    </div>
                </div>
            </div>
        </div>

        <hr />

        <BbButton Type="ButtonType.Submit">Save</BbButton>
        <BbButton Variant="ButtonVariant.Secondary" Href="projects">Cancel</BbButton>
    </form>
}

@code {
    [Parameter]
    public string Id { get; set; } = "";

    private bool _loading = true;
    private bool _notFound = false;
    private string _name = "";
    private string _localPath = "";
    private string _gitHubOwner = "";
    private string _gitHubRepo = "";
    private string _defaultBranch = "";
    private string? _defaultModel;

    protected override async Task OnInitializedAsync()
    {
        var project = await ProjectApi.GetProjectAsync(Id);
        if (project == null)
        {
            _notFound = true;
        }
        else
        {
            // Set breadcrumb context with project and page info
            await BreadcrumbService.SetContextAsync(new BreadcrumbContext { ProjectId = Id, PageName = "Edit" });

            _name = project.Name;
            _localPath = project.LocalPath;
            _gitHubOwner = project.GitHubOwner;
            _gitHubRepo = project.GitHubRepo;
            _defaultBranch = project.DefaultBranch;
            _defaultModel = project.DefaultModel;
        }
        _loading = false;
    }

    private async Task HandleSubmit()
    {
        await ProjectApi.UpdateProjectAsync(Id, new UpdateProjectRequest { DefaultModel = _defaultModel });
        Navigation.NavigateTo("projects");
    }
}
