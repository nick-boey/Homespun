<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Homespun</title>
    <base href="/"/>
    <!-- Figtree Font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600&display=swap" rel="stylesheet"/>
    <!-- Stylesheets -->
    <!--<link rel="stylesheet" href="css/tailwind.min.css"/>-->
    <link rel="stylesheet" href="app.css"/>
    
    <!-- Blazor Blueprint Theme (must load before component styles) -->
    <link rel="stylesheet" href="css/theme.css"/>
    <link href="_content/BlazorBlueprint.Components/blazorblueprint.css" rel="stylesheet"/>
    <link rel="icon" type="image/png" href="favicon.png"/>
    
    <!-- Apply theme before render to prevent flash -->
    <script>
        (function () {
            const theme = localStorage.getItem('homespun-theme') || 'auto';
            const isDark = theme === 'dark' ||
                (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);

            if (theme === 'auto') {
                document.documentElement.removeAttribute('data-theme');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }

            // Toggle .dark class for Blazor Blueprint
            if (isDark) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>

<body>
<div id="app">Loading...</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">X</a>
</div>

<script src="_framework/blazor.webassembly.js"></script>
<script>
    // Application Insights telemetry interop
    window.appInsights = {
        _initialized: false,
        _appInsights: null,

        initialize: async function (connectionString) {
            if (this._initialized) {
                return true;
            }

            try {
                // Dynamically load the Application Insights SDK
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://js.monitor.azure.com/scripts/b/ai.3.gbl.min.js';
                    script.crossOrigin = 'anonymous';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });

                // Wait for SDK to be available
                await new Promise(resolve => setTimeout(resolve, 100));

                if (typeof Microsoft === 'undefined' || !Microsoft.ApplicationInsights) {
                    console.error('[AppInsights] SDK not loaded');
                    return false;
                }

                // Initialize Application Insights
                const config = {
                    connectionString: connectionString,
                    enableAutoRouteTracking: false, // We handle this manually via NavigationTracker
                    disableFetchTracking: true, // We handle this via TelemetryDelegatingHandler
                    disableAjaxTracking: true,
                    enableCorsCorrelation: true,
                    enableRequestHeaderTracking: true,
                    enableResponseHeaderTracking: true
                };

                this._appInsights = new Microsoft.ApplicationInsights.ApplicationInsights({config: config});
                this._appInsights.loadAppInsights();
                this._initialized = true;

                console.log('[AppInsights] Initialized successfully');
                return true;
            } catch (error) {
                console.error('[AppInsights] Initialization failed:', error);
                return false;
            }
        },

        trackPageView: function (name, uri) {
            if (!this._initialized || !this._appInsights) return;
            try {
                this._appInsights.trackPageView({name: name, uri: uri || window.location.href});
            } catch (e) {
                console.error('[AppInsights] trackPageView error:', e);
            }
        },

        trackEvent: function (name, properties) {
            if (!this._initialized || !this._appInsights) return;
            try {
                this._appInsights.trackEvent({name: name, properties: properties || {}});
            } catch (e) {
                console.error('[AppInsights] trackEvent error:', e);
            }
        },

        trackException: function (message, stack, properties) {
            if (!this._initialized || !this._appInsights) return;
            try {
                const error = new Error(message);
                error.stack = stack;
                this._appInsights.trackException({exception: error, properties: properties || {}});
            } catch (e) {
                console.error('[AppInsights] trackException error:', e);
            }
        },

        trackDependency: function (type, target, name, duration, success, statusCode) {
            if (!this._initialized || !this._appInsights) return;
            try {
                this._appInsights.trackDependencyData({
                    id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
                    type: type,
                    target: target,
                    name: name,
                    duration: duration,
                    success: success,
                    responseCode: statusCode || 0
                });
            } catch (e) {
                console.error('[AppInsights] trackDependency error:', e);
            }
        }
    };

    window.themeManager = {
        getTheme: function () {
            return localStorage.getItem('homespun-theme') || 'auto';
        },
        setTheme: function (theme) {
            localStorage.setItem('homespun-theme', theme);
            var isDark = theme === 'dark' ||
                (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);

            if (theme === 'auto') {
                document.documentElement.removeAttribute('data-theme');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }

            // Toggle .dark class for Blazor Blueprint
            document.documentElement.classList.toggle('dark', isDark);
        }
    };
    window.sidebarManager = {
        isMobile: function () {
            return window.innerWidth <= 768;
        }
    };
    window.homespunInterop = {
        focusWithCursor: function (element, cursorPosition, valueLength) {
            requestAnimationFrame(function () {
                if (!element) return;
                element.focus();
                var len = valueLength || 0;
                if (cursorPosition === 'start') {
                    element.setSelectionRange(0, 0);
                } else if (cursorPosition === 'end') {
                    element.setSelectionRange(len, len);
                } else if (cursorPosition === 'replace') {
                    element.setSelectionRange(0, len);
                }
                // Prevent Tab from moving focus (only Tab, not other keys)
                if (!element.__tabPreventDefault) {
                    element.addEventListener('keydown', function (e) {
                        if (e.key === 'Tab') {
                            e.preventDefault();
                        }
                    });
                    element.__tabPreventDefault = true;
                }
            });
        },
        focusElement: function (element) {
            requestAnimationFrame(function () {
                if (element) {
                    element.focus();
                }
            });
        },
        blurElement: function (element) {
            if (element) {
                element.blur();
            }
        },
        scrollIssueIntoView: function (issueId) {
            requestAnimationFrame(function () {
                var element = document.querySelector('[data-issue-id="' + issueId + '"]');
                if (element) {
                    element.scrollIntoView({behavior: 'smooth', block: 'nearest'});
                }
            });
        },
        setupKeyboardPrevention: function (element) {
            if (!element || element.__keyboardPreventionSetup) return;

            // Keys that should have their default prevented
            var preventKeys = new Set([
                'j', 'k', 'h', 'l',
                'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight',
                'i', 'a', 'r',
                'o', 'O',
                'g', 'G',
                'u',
                'Escape',
                '/', 'n', 'N'  // Search: start search, next/previous match
            ]);

            element.addEventListener('keydown', function (e) {
                // Skip if typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                // Function keys (F1-F12) - always pass through
                if (e.key.match(/^F([1-9]|1[0-2])$/)) {
                    return;
                }

                // Prevent default only for keys we handle
                if (preventKeys.has(e.key)) {
                    e.preventDefault();
                }
            });

            element.__keyboardPreventionSetup = true;
        }
    };
</script>
</body>

</html>
