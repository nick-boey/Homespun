@inherits LayoutComponentBase
@implements IDisposable
@inject IBreadcrumbService BreadcrumbService
@inject IPanelService PanelService
@using System.Reflection

@inject HttpProjectApiService ProjectApi

<BbTooltipProvider/>
<BbDialogProvider/>

<BbResponsiveNavProvider>
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
            <BbResponsiveNavTrigger/>
            <BbBreadcrumb>
                <!-- 
                TODO: This should show BreadcrumbLink for all parent pages and a BreadcrumbPage for the current page.
                Likely requires modifications to the BreadcrumbService.
                 -->
                <BbBreadcrumbList>
                    <BbBreadcrumbItem>
                        <BbBreadcrumbLink Href="/">Homespun</BbBreadcrumbLink>
                    </BbBreadcrumbItem>
                    @foreach (var crumb in BreadcrumbService.Breadcrumbs)
                    {
                        <BbBreadcrumbSeparator/>
                        @if (crumb.Url != null)
                        {
                            <BbBreadcrumbLink Href="@crumb.Url">@crumb.Title</BbBreadcrumbLink>
                        }
                        else
                        {
                            <BbBreadcrumbPage>@crumb.Title</BbBreadcrumbPage>
                        }
                    }
                </BbBreadcrumbList>
            </BbBreadcrumb>
        </div>

        <div class="hidden md:flex items-center gap-6">
            <AgentStatusIndicator/>
            <span class="version-display" title="Homespun v@_version">v@_version</span>
        </div>
    </div>


    <BbResponsiveNavContent>
        <nav class="flex flex-col gap-4">
            <a href="#">Home</a>
            <a href="#">About</a>
            <a href="#">Contact</a>
        </nav>
    </BbResponsiveNavContent>
</BbResponsiveNavProvider>
<BbSidebarProvider>
    <BbSidebar>
        <BbSidebarHeader>
            <div class="flex items-center gap-2">
                <span class="font-semibold">Homespun</span>
            </div>
        </BbSidebarHeader>
        <BbSidebarContent>
            <BbSidebarMenu>
                <BbSidebarGroup>
                    <BbSidebarGroupLabel>Projects</BbSidebarGroupLabel>
                    <BbSidebarMenuItem>
                        <BbSidebarMenuButton IsActive="true" Match="NavLinkMatch.All" Href="projects">
                            <LucideIcon Name="list"/>
                            All
                        </BbSidebarMenuButton>
                    </BbSidebarMenuItem>

                    @foreach (var project in _projects)
                    {
                        <BbSidebarMenuItem>
                            <BbSidebarMenuButton Href="@($"projects/{project.Id}")">
                                @project.Name
                            </BbSidebarMenuButton>
                        </BbSidebarMenuItem>
                    }
                </BbSidebarGroup>
                <BbSidebarMenuItem>
                    <BbSidebarMenuButton Href="agents">
                        <LucideIcon Name="bot"/>
                        Agents
                    </BbSidebarMenuButton>
                </BbSidebarMenuItem>
                <BbSidebarMenuItem>
                    <BbSidebarMenuButton Href="prompts">
                        <LucideIcon Name="message-circle"/>
                        Prompts
                    </BbSidebarMenuButton>
                </BbSidebarMenuItem>
                <BbSidebarMenuItem>
                    <BbSidebarMenuButton Href="settings">
                        <LucideIcon Name="settings"/>
                        Settings
                    </BbSidebarMenuButton>
                </BbSidebarMenuItem>
            </BbSidebarMenu>
        </BbSidebarContent>
    </BbSidebar>
    <main>
        @Body
    </main>
</BbSidebarProvider>

@code {
    private List<Project> _projects = [];

    private string _version = GetShortVersion();

    private static string GetShortVersion()
    {
        var fullVersion = Assembly.GetExecutingAssembly()
            .GetCustomAttribute<AssemblyInformationalVersionAttribute>()?.InformationalVersion ?? "0.0.0";

        // Strip the +hash suffix if present (e.g., "0.1.0+abc123" -> "0.1.0")
        var plusIndex = fullVersion.IndexOf('+');
        return plusIndex > 0 ? fullVersion[..plusIndex] : fullVersion;
    }

    protected override void OnInitialized()
    {
        BreadcrumbService.OnBreadcrumbsChanged += OnBreadcrumbsChanged;
        PanelService.OnStateChanged += OnPanelStateChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        _projects = await ProjectApi.GetAllProjectsAsync();
    }

    private void OnBreadcrumbsChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void TogglePanel()
    {
        PanelService.TogglePanel();
    }

    private void OnPanelStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetPanelToggleTooltip()
    {
        if (!PanelService.IsPanelAvailable)
            return "No panel available on this page";

        return PanelService.IsPanelOpen ? "Close detail panel" : "Open detail panel";
    }

    public void Dispose()
    {
        BreadcrumbService.OnBreadcrumbsChanged -= OnBreadcrumbsChanged;
        PanelService.OnStateChanged -= OnPanelStateChanged;
    }

}
