@inherits LayoutComponentBase
@implements IDisposable
@inject IBreadcrumbService BreadcrumbService
@inject IPanelService PanelService
@using System.Reflection

@inject HttpProjectApiService ProjectApi

<BbTooltipProvider/>
<BbDialogProvider/>

<BbResponsiveNavProvider>
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
            <BbResponsiveNavTrigger/>
            <nav class="breadcrumbs" aria-label="Breadcrumb">
                <a href="" class="brand">Homespun</a>
                @foreach (var crumb in BreadcrumbService.Breadcrumbs)
                {
                    <span class="separator">/</span>
                    @if (crumb.Url != null)
                    {
                        <a href="@crumb.Url">@crumb.Title</a>
                    }
                    else
                    {
                        <span class="current">@crumb.Title</span>
                    }
                }
            </nav>
        </div>
    </div>
    <BbResponsiveNavContent>
        <nav class="flex flex-col gap-4">
            <a href="#">Home</a>
            <a href="#">About</a>
            <a href="#">Contact</a>
        </nav>
    </BbResponsiveNavContent>

    <div class="top-bar-spacer"></div>
    <AgentStatusIndicator/>
    <span class="version-display" title="Homespun v@_version">v@_version</span>
    <button class="panel-toggle @(PanelService.IsPanelAvailable ? "" : "disabled")"
            @onclick="TogglePanel"
            disabled="@(!PanelService.IsPanelAvailable)"
            title="@GetPanelToggleTooltip()">
        @if (PanelService.IsPanelOpen)
        {
            <LucideIcon Name="panel-right-close" Size="18"/>
        }
        else
        {
            <LucideIcon Name="panel-right" Size="18"/>
        }
    </button>
</BbResponsiveNavProvider>
<BbSidebarProvider>
    <BbSidebar>
        <BbSidebarHeader>
            <div class="flex items-center gap-2">
                <span class="font-semibold">Homespun</span>
            </div>
        </BbSidebarHeader>
        <BbSidebarContent>
            <BbSidebarMenu>
                <BbSidebarGroup>
                    <BbSidebarGroupLabel>Projects</BbSidebarGroupLabel>
                    <BbSidebarMenuItem>
                        <BbSidebarMenuButton IsActive="true" Match="NavLinkMatch.All" Href="projects">
                            <LucideIcon Name="list"/>
                            All
                        </BbSidebarMenuButton>
                    </BbSidebarMenuItem>

                    @foreach (var project in _projects)
                    {
                        <BbSidebarMenuItem>
                            <BbSidebarMenuButton Href="@($"projects/{project.Id}")">
                                @project.Name
                            </BbSidebarMenuButton>
                        </BbSidebarMenuItem>
                    }
                </BbSidebarGroup>
                <BbSidebarMenuItem>
                    <BbSidebarMenuButton Href="agents">
                        <LucideIcon Name="bot"/>
                        Agents
                    </BbSidebarMenuButton>
                </BbSidebarMenuItem>
                <BbSidebarMenuItem>
                    <BbSidebarMenuButton Href="prompts">
                        <LucideIcon Name="message-circle"/>
                        Prompts
                    </BbSidebarMenuButton>
                </BbSidebarMenuItem>
                <BbSidebarMenuItem>
                    <BbSidebarMenuButton Href="settings">
                        <LucideIcon Name="settings"/>
                        Settings
                    </BbSidebarMenuButton>
                </BbSidebarMenuItem>
            </BbSidebarMenu>
        </BbSidebarContent>
    </BbSidebar>
    <main class="main-content">
        <article class="content">
            <NotificationBanner/>
            @Body
        </article>
    </main>
</BbSidebarProvider>

@code {
    private List<Project> _projects = [];

    private string _version = GetShortVersion();

    private static string GetShortVersion()
    {
        var fullVersion = Assembly.GetExecutingAssembly()
            .GetCustomAttribute<AssemblyInformationalVersionAttribute>()?.InformationalVersion ?? "0.0.0";

        // Strip the +hash suffix if present (e.g., "0.1.0+abc123" -> "0.1.0")
        var plusIndex = fullVersion.IndexOf('+');
        return plusIndex > 0 ? fullVersion[..plusIndex] : fullVersion;
    }

    protected override void OnInitialized()
    {
        BreadcrumbService.OnBreadcrumbsChanged += OnBreadcrumbsChanged;
        PanelService.OnStateChanged += OnPanelStateChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        _projects = await ProjectApi.GetAllProjectsAsync();
    }

    private void OnBreadcrumbsChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void TogglePanel()
    {
        PanelService.TogglePanel();
    }

    private void OnPanelStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetPanelToggleTooltip()
    {
        if (!PanelService.IsPanelAvailable)
            return "No panel available on this page";

        return PanelService.IsPanelOpen ? "Close detail panel" : "Open detail panel";
    }

    public void Dispose()
    {
        BreadcrumbService.OnBreadcrumbsChanged -= OnBreadcrumbsChanged;
        PanelService.OnStateChanged -= OnPanelStateChanged;
    }

}
