@inherits LayoutComponentBase
@implements IDisposable
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IBreadcrumbService BreadcrumbService
@inject IPanelService PanelService
@using System.Reflection

<div class="page @(_sidebarOpen ? "sidebar-open" : "sidebar-closed")" @onkeydown="HandleKeyDown" tabindex="-1">
    <header class="top-bar">
        <button class="sidebar-toggle" @onclick="ToggleSidebar" title="Toggle sidebar">
            <span class="toggle-icon"></span>
        </button>
        <nav class="breadcrumbs" aria-label="Breadcrumb">
            <a href="" class="brand">Homespun</a>
            @foreach (var crumb in BreadcrumbService.Breadcrumbs)
            {
                <span class="separator">/</span>
                @if (crumb.Url != null)
                {
                    <a href="@crumb.Url">@crumb.Title</a>
                }
                else
                {
                    <span class="current">@crumb.Title</span>
                }
            }
        </nav>
        <div class="top-bar-spacer"></div>
        <AgentStatusIndicator />
        <span class="version-display" title="Homespun v@_version">v@_version</span>
        <button class="panel-toggle @(PanelService.IsPanelAvailable ? "" : "disabled")"
                @onclick="TogglePanel"
                disabled="@(!PanelService.IsPanelAvailable)"
                title="@GetPanelToggleTooltip()">
            <i class="bi @(PanelService.IsPanelOpen ? "bi-layout-sidebar-inset-reverse" : "bi-layout-sidebar-reverse")"></i>
        </button>
    </header>

    <aside class="sidebar">
        <NavMenu />
    </aside>

    @if (_sidebarOpen)
    {
        <div class="sidebar-backdrop" @onclick="CloseSidebar"></div>
    }

    <main class="main-content">
        <article class="content">
            <NotificationBanner />
            @Body
        </article>
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">X</span>
</div>

@code {
    private bool _sidebarOpen = false;
    private string _version = GetShortVersion();

    private static string GetShortVersion()
    {
        var fullVersion = Assembly.GetExecutingAssembly()
            .GetCustomAttribute<AssemblyInformationalVersionAttribute>()?.InformationalVersion ?? "0.0.0";

        // Strip the +hash suffix if present (e.g., "0.1.0+abc123" -> "0.1.0")
        var plusIndex = fullVersion.IndexOf('+');
        return plusIndex > 0 ? fullVersion[..plusIndex] : fullVersion;
    }

    protected override void OnInitialized()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
        BreadcrumbService.OnBreadcrumbsChanged += OnBreadcrumbsChanged;
        PanelService.OnStateChanged += OnPanelStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Set sidebar open for desktop, closed for mobile
            var isMobile = await JSRuntime.InvokeAsync<bool>("sidebarManager.isMobile");
            _sidebarOpen = !isMobile;

            StateHasChanged();
        }
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Close sidebar on mobile when navigating
        var isMobile = await JSRuntime.InvokeAsync<bool>("sidebarManager.isMobile");
        if (isMobile && _sidebarOpen)
        {
            _sidebarOpen = false;
        }

        StateHasChanged();
    }

    private void OnBreadcrumbsChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void ToggleSidebar()
    {
        _sidebarOpen = !_sidebarOpen;
    }

    private void CloseSidebar()
    {
        _sidebarOpen = false;
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        // Don't close sidebar on Escape - let page components handle Escape
        // The sidebar can be closed via backdrop click or toggle button
    }

    private void TogglePanel()
    {
        PanelService.TogglePanel();
    }

    private void OnPanelStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetPanelToggleTooltip()
    {
        if (!PanelService.IsPanelAvailable)
            return "No panel available on this page";

        return PanelService.IsPanelOpen ? "Close detail panel" : "Open detail panel";
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        BreadcrumbService.OnBreadcrumbsChanged -= OnBreadcrumbsChanged;
        PanelService.OnStateChanged -= OnPanelStateChanged;
    }
}
