@*
    SplitButton Component

    A button with a primary action and a dropdown for secondary actions.

    Usage:
    <SplitButton PrimaryText="Pull"
                 PrimaryOnClick="HandlePullAsync"
                 Variant="ButtonVariant.Default"
                 Actions="@_actions" />
*@

<div class="split-button @CssClass">
    @* Backdrop to close dropdown when clicking outside *@
    @if (_isDropdownOpen)
    {
        <div class="split-button-backdrop" @onclick="CloseDropdown"></div>
    }

    @* Primary button *@
    <BbButton Variant="@Variant"
              Size="@GetSize()"
              Class="split-button-primary"
              Disabled="@(IsLoading || Disabled)"
              Loading="@(IsLoading && _activeAction == null)"
              OnClick="HandlePrimaryClick">
        @if (IsLoading && _activeAction == null)
        {
            @if (!string.IsNullOrEmpty(PrimaryLoadingText))
            {
                @PrimaryLoadingText
            }
            else
            {
                @PrimaryText
            }
        }
        else
        {
            @if (PrimaryIcon != null)
            {
                @PrimaryIcon
            }
            @PrimaryText
        }
    </BbButton>

    @* Dropdown toggle button *@
    <span @onclick:stopPropagation="true">
        <BbButton Variant="@Variant"
                  Size="@GetSize()"
                  Class="split-button-toggle"
                  Disabled="@(IsLoading || Disabled)"
                  OnClick="ToggleDropdown">
            <LucideIcon Name="chevron-down" Size="14" />
        </BbButton>
    </span>

    @* Dropdown menu *@
    @if (_isDropdownOpen)
    {
        <div class="split-button-menu">
            @foreach (var action in Actions)
            {
                <BbButton Variant="ButtonVariant.Ghost"
                          Class="split-button-item"
                          Disabled="@IsLoading"
                          Loading="@(IsLoading && _activeAction == action.Key)"
                          OnClick="() => HandleActionClick(action)">
                    @if (!(IsLoading && _activeAction == action.Key) && action.Icon != null)
                    {
                        <span class="me-2">@action.Icon</span>
                    }
                    @action.Text
                </BbButton>
            }
        </div>
    }
</div>

@code {
    /// <summary>
    /// Text to display on the primary button.
    /// </summary>
    [Parameter]
    public string PrimaryText { get; set; } = "";

    /// <summary>
    /// Text to display on the primary button when loading.
    /// </summary>
    [Parameter]
    public string? PrimaryLoadingText { get; set; }

    /// <summary>
    /// Icon to display on the primary button.
    /// </summary>
    [Parameter]
    public RenderFragment? PrimaryIcon { get; set; }

    /// <summary>
    /// Click handler for the primary button.
    /// </summary>
    [Parameter]
    public EventCallback<MouseEventArgs> PrimaryOnClick { get; set; }

    /// <summary>
    /// Secondary actions to display in the dropdown.
    /// </summary>
    [Parameter]
    public IReadOnlyList<SplitButtonAction> Actions { get; set; } = [];

    /// <summary>
    /// CSS class for the container (e.g., for sizing).
    /// </summary>
    [Parameter]
    public string CssClass { get; set; } = "";

    /// <summary>
    /// Button variant style.
    /// </summary>
    [Parameter]
    public ButtonVariant Variant { get; set; } = ButtonVariant.Default;

    /// <summary>
    /// Button size.
    /// </summary>
    [Parameter]
    public ButtonSize? Size { get; set; }

    /// <summary>
    /// Whether the button is in loading state (externally controlled).
    /// </summary>
    [Parameter]
    public bool? IsLoadingExternal { get; set; }

    /// <summary>
    /// Whether the button is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    private bool _isDropdownOpen;
    private bool _isLoadingInternal;
    private string? _activeAction;

    private bool IsLoading => IsLoadingExternal ?? _isLoadingInternal;

    private ButtonSize GetSize() => Size ?? ButtonSize.Default;

    private void ToggleDropdown()
    {
        if (!IsLoading && !Disabled)
        {
            _isDropdownOpen = !_isDropdownOpen;
        }
    }

    private void CloseDropdown()
    {
        _isDropdownOpen = false;
    }

    private async Task HandlePrimaryClick(MouseEventArgs args)
    {
        if (IsLoading || Disabled)
            return;

        CloseDropdown();

        if (IsLoadingExternal.HasValue)
        {
            await PrimaryOnClick.InvokeAsync(args);
            return;
        }

        _isLoadingInternal = true;
        _activeAction = null;
        StateHasChanged();

        try
        {
            await PrimaryOnClick.InvokeAsync(args);
        }
        finally
        {
            _isLoadingInternal = false;
            StateHasChanged();
        }
    }

    private async Task HandleActionClick(SplitButtonAction action)
    {
        if (IsLoading || Disabled)
            return;

        CloseDropdown();

        if (IsLoadingExternal.HasValue)
        {
            await action.OnClick.InvokeAsync();
            return;
        }

        _isLoadingInternal = true;
        _activeAction = action.Key;
        StateHasChanged();

        try
        {
            await action.OnClick.InvokeAsync();
        }
        finally
        {
            _isLoadingInternal = false;
            _activeAction = null;
            StateHasChanged();
        }
    }
}
