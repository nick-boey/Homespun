@inject HttpNotificationApiService NotificationApi

@if (_notifications.Count > 0)
{
    <div class="flex flex-col gap-sm mb-md">
        @foreach (var notification in _notifications)
        {
            <div class="notification-banner notification-@notification.Type.ToString().ToLower()">
                <div class="notification-content flex items-center gap-sm flex-1 min-w-0">
                    <div class="notification-icon flex-shrink-0 flex items-center justify-center">
                        @GetIcon(notification.Type)
                    </div>
                    <div class="notification-text flex items-baseline gap-sm flex-wrap min-w-0">
                        <span class="notification-title font-semibold whitespace-nowrap">@notification.Title</span>
                        <span class="notification-message text-text-secondary overflow-hidden text-ellipsis">@notification.Message</span>
                    </div>
                </div>
                <div class="notification-actions flex items-center gap-sm flex-shrink-0">
                    @if (notification.IsDismissible)
                    {
                        <button class="notification-dismiss flex items-center justify-center w-6 h-6 p-0 bg-transparent border-none rounded-sm cursor-pointer text-text-muted hover:bg-bg-hover hover:text-text-primary transition-fast focus:outline-none focus-visible:ring-2 focus-visible:ring-ocean/30" @onclick="() => Dismiss(notification.Id)" title="Dismiss">
                            <i class="bi bi-x-lg" aria-hidden="true"></i>
                        </button>
                    }
                </div>
            </div>
        }
    </div>
}

@code {
    /// <summary>
    /// Optional project ID to filter notifications by project.
    /// </summary>
    [Parameter]
    public string? ProjectId { get; set; }

    private List<NotificationDto> _notifications = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadNotificationsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadNotificationsAsync();
    }

    private async Task LoadNotificationsAsync()
    {
        _notifications = await NotificationApi.GetNotificationsAsync(ProjectId);
    }

    private async Task Dismiss(string notificationId)
    {
        await NotificationApi.DismissNotificationAsync(notificationId);
        await LoadNotificationsAsync();
    }

    private static MarkupString GetIcon(NotificationType type)
    {
        var iconClass = type switch
        {
            NotificationType.Info => "bi-info-circle",
            NotificationType.Warning => "bi-exclamation-triangle",
            NotificationType.ActionRequired => "bi-exclamation-circle",
            _ => "bi-circle"
        };
        return new MarkupString($"""<i class="bi {iconClass}" aria-hidden="true"></i>""");
    }
}
