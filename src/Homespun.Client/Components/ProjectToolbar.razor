@using Homespun.Shared.Models.Sessions
@using Homespun.Client.Services

@inject IKeyboardNavigationService NavService

<div class="project-toolbar">
    @* Creation buttons *@
    <ToolbarButton Icon="arrow-up-from-line"
                   Tooltip="Create issue above (Shift+O)"
                   TestId="toolbar-create-above-button"
                   Disabled="@CreateDisabled"
                   OnClick="HandleCreateAbove" />

    <ToolbarButton Icon="arrow-down-from-line"
                   Tooltip="Create issue below (O)"
                   TestId="toolbar-create-below-button"
                   Disabled="@CreateDisabled"
                   OnClick="HandleCreateBelow" />

    <ToolbarSeparator />

    @* Hierarchy buttons *@
    <ToolbarButton Icon="corner-right-up"
                   Tooltip="Make child of another (click to select target)"
                   TestId="toolbar-child-of-button"
                   Disabled="@ChildOfDisabled"
                   Active="@ChildOfActive"
                   OnClick="HandleMakeChildOf" />

    <ToolbarButton Icon="corner-left-down"
                   Tooltip="Make parent of another (click to select target)"
                   TestId="toolbar-parent-of-button"
                   Disabled="@ParentOfDisabled"
                   Active="@ParentOfActive"
                   OnClick="HandleMakeParentOf" />

    <ToolbarSeparator />

    @* Undo/Redo buttons *@
    <ToolbarButton Icon="undo"
                   Tooltip="@(UndoTooltip ?? "Undo")"
                   TestId="toolbar-undo-button"
                   Disabled="@UndoDisabled"
                   OnClick="HandleUndo" />

    <ToolbarButton Icon="redo"
                   Tooltip="@(RedoTooltip ?? "Redo")"
                   TestId="toolbar-redo-button"
                   Disabled="@RedoDisabled"
                   OnClick="HandleRedo" />

    <ToolbarSeparator />

    @* Edit button *@
    <ToolbarButton Icon="pencil"
                   Tooltip="Edit issue (i)"
                   TestId="toolbar-edit-button"
                   Disabled="@(SelectedIssueId == null)"
                   OnClick="HandleEdit" />

    @* Run button with dropdown *@
    <div class="toolbar-run-wrapper">
        <ToolbarButton Icon="play"
                       Tooltip="Run agent"
                       TestId="toolbar-run-button"
                       Disabled="@(SelectedIssueId == null || IsAgentRunning)"
                       OnClick="ToggleDropdown" />

        @if (_showDropdown && SelectedIssueId != null)
        {
            <div class="toolbar-agent-dropdown" @onclick:stopPropagation="true">
                <div class="dropdown-content">
                    <UnifiedAgentLauncher
                        EntityId="@SelectedIssueId"
                        ProjectId="@ProjectId"
                        EntityTitle="@IssueTitle"
                        EntityDescription="@IssueDescription"
                        EntityType="@IssueType"
                        BranchName="@BranchName"
                        RepoPath="@RepoPath"
                        DefaultBranch="@DefaultBranch"
                        DefaultModel="@DefaultModel"
                        Compact="true"
                        OnSessionStarted="HandleSessionStarted" />
                </div>
            </div>
        }
    </div>
</div>

<style>
    .project-toolbar {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm, 8px);
        padding-top: var(--spacing-sm, 8px);
    }

    .toolbar-run-wrapper {
        position: relative;
    }

    .toolbar-agent-dropdown {
        position: fixed;
        z-index: 1000;
        min-width: 240px;
        margin-top: 4px;
        background: var(--bg-primary, #1a1a2e);
        border: 1px solid var(--border-color, rgba(255, 255, 255, 0.1));
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .dropdown-content {
        padding: 12px;
    }
</style>

@code {
    /// <summary>
    /// The currently selected issue ID. Null if no issue is selected.
    /// </summary>
    [Parameter]
    public string? SelectedIssueId { get; set; }

    /// <summary>
    /// The project ID for navigation and agent context.
    /// </summary>
    [Parameter, EditorRequired]
    public required string ProjectId { get; set; }

    /// <summary>
    /// Whether an agent is currently running on the selected issue.
    /// </summary>
    [Parameter]
    public bool IsAgentRunning { get; set; }

    /// <summary>
    /// Callback when the edit button is clicked.
    /// </summary>
    [Parameter]
    public EventCallback<string> OnEditClick { get; set; }

    /// <summary>
    /// Callback when a session is successfully started.
    /// </summary>
    [Parameter]
    public EventCallback<ClaudeSession> OnSessionStarted { get; set; }

    /// <summary>
    /// The issue title for prompt template rendering.
    /// </summary>
    [Parameter]
    public string? IssueTitle { get; set; }

    /// <summary>
    /// The issue description for prompt template rendering.
    /// </summary>
    [Parameter]
    public string? IssueDescription { get; set; }

    /// <summary>
    /// The issue type for prompt template rendering (e.g., "Feature", "Bug").
    /// </summary>
    [Parameter]
    public string? IssueType { get; set; }

    /// <summary>
    /// The branch name for the issue.
    /// </summary>
    [Parameter]
    public string? BranchName { get; set; }

    /// <summary>
    /// Path to the main repository (for listing branches).
    /// </summary>
    [Parameter]
    public string? RepoPath { get; set; }

    /// <summary>
    /// Default branch of the project.
    /// </summary>
    [Parameter]
    public string? DefaultBranch { get; set; }

    /// <summary>
    /// Default model to use.
    /// </summary>
    [Parameter]
    public string DefaultModel { get; set; } = "opus";

    // Creation button parameters

    /// <summary>
    /// Whether the create above/below buttons are disabled.
    /// </summary>
    [Parameter]
    public bool CreateDisabled { get; set; }

    /// <summary>
    /// Callback when the create above button is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnCreateAbove { get; set; }

    /// <summary>
    /// Callback when the create below button is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnCreateBelow { get; set; }

    // Hierarchy button parameters

    /// <summary>
    /// Whether the "Make Child Of" button is disabled.
    /// </summary>
    [Parameter]
    public bool ChildOfDisabled { get; set; }

    /// <summary>
    /// Whether the "Make Parent Of" button is disabled.
    /// </summary>
    [Parameter]
    public bool ParentOfDisabled { get; set; }

    /// <summary>
    /// Whether the "Make Child Of" button is in active selection mode.
    /// </summary>
    [Parameter]
    public bool ChildOfActive { get; set; }

    /// <summary>
    /// Whether the "Make Parent Of" button is in active selection mode.
    /// </summary>
    [Parameter]
    public bool ParentOfActive { get; set; }

    /// <summary>
    /// Callback when the "Make Child Of" button is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnMakeChildOf { get; set; }

    /// <summary>
    /// Callback when the "Make Parent Of" button is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnMakeParentOf { get; set; }

    // Undo/Redo button parameters

    /// <summary>
    /// Whether the undo button is disabled.
    /// </summary>
    [Parameter]
    public bool UndoDisabled { get; set; }

    /// <summary>
    /// Whether the redo button is disabled.
    /// </summary>
    [Parameter]
    public bool RedoDisabled { get; set; }

    /// <summary>
    /// Tooltip text for the undo button (can include the action description).
    /// </summary>
    [Parameter]
    public string? UndoTooltip { get; set; }

    /// <summary>
    /// Tooltip text for the redo button (can include the action description).
    /// </summary>
    [Parameter]
    public string? RedoTooltip { get; set; }

    /// <summary>
    /// Callback when the undo button is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnUndo { get; set; }

    /// <summary>
    /// Callback when the redo button is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnRedo { get; set; }

    private bool _showDropdown;

    private async Task HandleEdit()
    {
        if (SelectedIssueId == null) return;
        await OnEditClick.InvokeAsync(SelectedIssueId);
    }

    private void ToggleDropdown()
    {
        if (SelectedIssueId == null || IsAgentRunning) return;
        _showDropdown = !_showDropdown;
    }

    private async Task HandleSessionStarted(ClaudeSession session)
    {
        _showDropdown = false;
        await OnSessionStarted.InvokeAsync(session);
    }

    private async Task HandleCreateAbove()
    {
        if (CreateDisabled) return;

        if (OnCreateAbove.HasDelegate)
        {
            await OnCreateAbove.InvokeAsync();
        }
        else
        {
            NavService.CreateIssueAbove();
        }
    }

    private async Task HandleCreateBelow()
    {
        if (CreateDisabled) return;

        if (OnCreateBelow.HasDelegate)
        {
            await OnCreateBelow.InvokeAsync();
        }
        else
        {
            NavService.CreateIssueBelow();
        }
    }

    private async Task HandleMakeChildOf()
    {
        if (ChildOfDisabled) return;

        if (OnMakeChildOf.HasDelegate)
        {
            await OnMakeChildOf.InvokeAsync();
        }
        else
        {
            NavService.StartMakeChildOf();
        }
    }

    private async Task HandleMakeParentOf()
    {
        if (ParentOfDisabled) return;

        if (OnMakeParentOf.HasDelegate)
        {
            await OnMakeParentOf.InvokeAsync();
        }
        else
        {
            NavService.StartMakeParentOf();
        }
    }

    private async Task HandleUndo()
    {
        if (UndoDisabled) return;
        await OnUndo.InvokeAsync();
    }

    private async Task HandleRedo()
    {
        if (RedoDisabled) return;
        await OnRedo.InvokeAsync();
    }
}
