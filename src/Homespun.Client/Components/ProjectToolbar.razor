@using Homespun.Shared.Models.Sessions

<div class="project-toolbar">
    <ToolbarButton Icon="bi-pencil"
                   Tooltip="Edit issue (i)"
                   TestId="toolbar-edit-button"
                   Disabled="@(SelectedIssueId == null)"
                   OnClick="HandleEdit" />

    <div class="toolbar-run-wrapper">
        <ToolbarButton Icon="bi-play-fill"
                       Tooltip="Run agent"
                       TestId="toolbar-run-button"
                       Disabled="@(SelectedIssueId == null || IsAgentRunning)"
                       OnClick="ToggleDropdown" />

        @if (_showDropdown && SelectedIssueId != null)
        {
            <div class="toolbar-agent-dropdown" @onclick:stopPropagation="true">
                <div class="dropdown-content">
                    <UnifiedAgentLauncher
                        EntityId="@SelectedIssueId"
                        ProjectId="@ProjectId"
                        EntityTitle="@IssueTitle"
                        EntityDescription="@IssueDescription"
                        EntityType="@IssueType"
                        BranchName="@BranchName"
                        RepoPath="@RepoPath"
                        DefaultBranch="@DefaultBranch"
                        DefaultModel="@DefaultModel"
                        Compact="true"
                        OnSessionStarted="HandleSessionStarted" />
                </div>
            </div>
        }
    </div>
</div>

<style>
    .project-toolbar {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm, 8px);
        padding-top: var(--spacing-sm, 8px);
    }

    .toolbar-run-wrapper {
        position: relative;
    }

    .toolbar-agent-dropdown {
        position: fixed;
        z-index: 1000;
        min-width: 240px;
        margin-top: 4px;
        background: var(--bg-primary, #1a1a2e);
        border: 1px solid var(--border-color, rgba(255, 255, 255, 0.1));
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .dropdown-content {
        padding: 12px;
    }
</style>

@code {
    /// <summary>
    /// The currently selected issue ID. Null if no issue is selected.
    /// </summary>
    [Parameter]
    public string? SelectedIssueId { get; set; }

    /// <summary>
    /// The project ID for navigation and agent context.
    /// </summary>
    [Parameter, EditorRequired]
    public required string ProjectId { get; set; }

    /// <summary>
    /// Whether an agent is currently running on the selected issue.
    /// </summary>
    [Parameter]
    public bool IsAgentRunning { get; set; }

    /// <summary>
    /// Callback when the edit button is clicked.
    /// </summary>
    [Parameter]
    public EventCallback<string> OnEditClick { get; set; }

    /// <summary>
    /// Callback when a session is successfully started.
    /// </summary>
    [Parameter]
    public EventCallback<ClaudeSession> OnSessionStarted { get; set; }

    /// <summary>
    /// The issue title for prompt template rendering.
    /// </summary>
    [Parameter]
    public string? IssueTitle { get; set; }

    /// <summary>
    /// The issue description for prompt template rendering.
    /// </summary>
    [Parameter]
    public string? IssueDescription { get; set; }

    /// <summary>
    /// The issue type for prompt template rendering (e.g., "Feature", "Bug").
    /// </summary>
    [Parameter]
    public string? IssueType { get; set; }

    /// <summary>
    /// The branch name for the issue.
    /// </summary>
    [Parameter]
    public string? BranchName { get; set; }

    /// <summary>
    /// Path to the main repository (for listing branches).
    /// </summary>
    [Parameter]
    public string? RepoPath { get; set; }

    /// <summary>
    /// Default branch of the project.
    /// </summary>
    [Parameter]
    public string? DefaultBranch { get; set; }

    /// <summary>
    /// Default model to use.
    /// </summary>
    [Parameter]
    public string DefaultModel { get; set; } = "opus";

    private bool _showDropdown;

    private async Task HandleEdit()
    {
        if (SelectedIssueId == null) return;
        await OnEditClick.InvokeAsync(SelectedIssueId);
    }

    private void ToggleDropdown()
    {
        if (SelectedIssueId == null || IsAgentRunning) return;
        _showDropdown = !_showDropdown;
    }

    private async Task HandleSessionStarted(ClaudeSession session)
    {
        _showDropdown = false;
        await OnSessionStarted.InvokeAsync(session);
    }
}
