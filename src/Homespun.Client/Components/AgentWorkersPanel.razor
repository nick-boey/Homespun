@using Fleece.Core.Models

@inject HttpSessionApiService SessionStoreApi
@inject HttpSessionApiService SessionApi
@inject HttpProjectApiService ProjectApi
@inject HttpPullRequestApiService PullRequestApi
@inject HttpIssueApiService IssueApi

<div class="agent-workers-panel">
    @if (_entityGroups.Count == 0)
    {
        <div class="empty-state">
            <div class="empty-icon"><i class="bi bi-cpu"></i></div>
            <h5>No Active Agent Workers</h5>
            <p class="text-text-muted">Agent workers started from issues or pull requests will appear here.</p>
        </div>
    }
    else
    {
        @foreach (var group in _entityGroups)
        {
            <div class="entity-group mb-4">
                <div class="entity-group-header">
                    <div class="entity-group-title">
                        <span class="entity-type-badge @GetEntityTypeBadgeClass(group.EntityType)">
                            @group.EntityType
                        </span>
                        <span class="entity-name">@group.EntityTitle</span>
                        <span class="badge bg-secondary ms-2">@group.Sessions.Count worker@(group.Sessions.Count != 1 ? "s" : "")</span>
                    </div>
                    <div class="entity-group-actions">
                        @if (group.Sessions.Count > 1)
                        {
                            <button class="btn btn-sm btn-outline-danger"
                                    @onclick="() => StopAllForEntity(group.EntityId)"
                                    disabled="@(_stoppingEntities.Contains(group.EntityId))">
                                @if (_stoppingEntities.Contains(group.EntityId))
                                {
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                }
                                Stop All (@group.Sessions.Count)
                            </button>
                        }
                    </div>
                </div>

                <div class="sessions-list">
                    @{ var orderedSessions = group.Sessions.OrderByDescending(s => s.CreatedAt).ToList(); }
                    @for (var i = 0; i < orderedSessions.Count; i++)
                    {
                        var session = orderedSessions[i];
                        var isCurrent = i == 0;
                        var uptime = DateTime.UtcNow - session.CreatedAt;
                        var lastActivity = DateTime.UtcNow - session.LastActivityAt;

                        <div class="session-card @(!isCurrent ? "superseded" : "")">
                            <div class="session-card-header">
                                <div class="session-title">
                                    @if (!isCurrent)
                                    {
                                        <span class="badge bg-warning text-dark me-1">Superseded</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success me-1">Current</span>
                                    }
                                    <span class="status-indicator @session.Status.ToIndicatorClass()" title="@session.Status.ToDisplayLabel()"></span>
                                    <code class="session-id-display">@session.Id[..8]</code>
                                </div>
                            </div>

                            <div class="session-card-body">
                                <div class="session-details">
                                    <div class="detail-row">
                                        <span class="detail-label">Status:</span>
                                        <span class="badge @session.Status.ToBadgeClass()">@session.Status.ToDisplayLabel()</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Mode:</span>
                                        <span class="badge @(session.Mode == SessionMode.Plan ? "bg-status-info" : "bg-status-success")">@session.Mode</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Model:</span>
                                        <code class="detail-value">@GetModelDisplayName(session.Model)</code>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Started:</span>
                                        <span class="detail-value" title="@session.CreatedAt.ToString("O")">@FormatUptime(uptime) ago</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Last Active:</span>
                                        <span class="detail-value" title="@session.LastActivityAt.ToString("O")">@FormatUptime(lastActivity) ago</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Messages:</span>
                                        <span class="detail-value">@session.MessageCount</span>
                                    </div>
                                </div>
                            </div>

                            <div class="session-card-footer">
                                <a href="/session/@session.Id" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-chat-dots me-1"></i>Chat
                                </a>
                                <button class="btn btn-sm btn-outline-danger"
                                        @onclick="() => StopSession(session.Id)"
                                        disabled="@(_stoppingSessions.Contains(session.Id))">
                                    @if (_stoppingSessions.Contains(session.Id))
                                    {
                                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                    }
                                    <i class="bi bi-stop-circle me-1"></i>Kill
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger mt-3">@_errorMessage</div>
    }
</div>

<style>
    .agent-workers-panel {
        max-width: 1200px;
    }

    .agent-workers-panel .empty-state {
        text-align: center;
        padding: var(--spacing-xl) var(--spacing-lg);
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
    }

    .agent-workers-panel .empty-icon {
        font-size: 3rem;
        margin-bottom: var(--spacing-md);
        color: var(--text-muted);
    }

    .agent-workers-panel .empty-state h5 {
        margin-bottom: var(--spacing-sm);
        color: var(--text-primary);
    }

    .entity-group {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .entity-group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
    }

    .entity-group-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        flex: 1;
        min-width: 0;
    }

    .entity-name {
        font-weight: 600;
        font-size: 0.95rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .entity-group-actions {
        flex-shrink: 0;
        margin-left: var(--spacing-md);
    }

    .agent-workers-panel .sessions-list {
        padding: var(--spacing-md);
    }

    .agent-workers-panel .session-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-md);
        overflow: hidden;
    }

    .agent-workers-panel .session-card:last-child {
        margin-bottom: 0;
    }

    .agent-workers-panel .session-card.superseded {
        opacity: 0.7;
        border-color: var(--border-color);
        border-style: dashed;
    }

    .agent-workers-panel .session-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
    }

    .agent-workers-panel .session-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .session-id-display {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .agent-workers-panel .entity-type-badge {
        padding: 0.125rem 0.5rem;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        flex-shrink: 0;
    }

    .agent-workers-panel .entity-type-badge.pr {
        background: var(--status-info);
        color: white;
    }

    .agent-workers-panel .entity-type-badge.issue {
        background: var(--status-warning);
        color: white;
    }

    .agent-workers-panel .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .agent-workers-panel .status-indicator.running {
        background: var(--status-success);
        animation: pulse 1.5s ease-in-out infinite;
    }

    .agent-workers-panel .status-indicator.processing {
        background: var(--status-info);
        animation: pulse 1s ease-in-out infinite;
    }

    .agent-workers-panel .status-indicator.waiting {
        background: var(--status-warning);
    }

    .agent-workers-panel .status-indicator.question {
        background: var(--status-question);
        animation: pulse 1s ease-in-out infinite;
    }

    .agent-workers-panel .status-indicator.stopped {
        background: var(--text-muted);
    }

    .agent-workers-panel .status-indicator.error {
        background: var(--status-error);
    }

    .agent-workers-panel .session-card-body {
        padding: var(--spacing-md);
    }

    .agent-workers-panel .session-details {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
    }

    .agent-workers-panel .detail-row {
        display: flex;
        align-items: baseline;
        gap: var(--spacing-sm);
        font-size: 0.875rem;
    }

    .agent-workers-panel .detail-label {
        color: var(--text-muted);
        font-weight: 500;
        min-width: 85px;
        flex-shrink: 0;
    }

    .agent-workers-panel .detail-value {
        color: var(--text-secondary);
    }

    .agent-workers-panel .session-card-footer {
        display: flex;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--bg-secondary);
        border-top: 1px solid var(--border-color);
    }
</style>

@code {
    [Parameter] public string ProjectId { get; set; } = "";
    [Parameter] public EventCallback OnDataChanged { get; set; }

    private List<EntityGroupInfo> _entityGroups = [];
    private HashSet<string> _stoppingSessions = new();
    private HashSet<string> _stoppingEntities = new();
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
    }

    protected override async Task OnParametersSetAsync()
    {
        await RefreshData();
    }

    private async Task RefreshData()
    {
        var sessions = await SessionStoreApi.GetProjectSessionsAsync(ProjectId);
        var project = await ProjectApi.GetProjectAsync(ProjectId);

        // Group sessions by entity ID
        var grouped = sessions
            .GroupBy(s => s.EntityId)
            .ToList();

        var entityGroups = new List<EntityGroupInfo>();

        foreach (var group in grouped)
        {
            var entityId = group.Key;
            var entityTitle = entityId;
            var entityType = "Unknown";

            // Try to resolve entity info
            try
            {
                var pr = await PullRequestApi.GetPullRequestAsync(entityId);
                if (pr != null)
                {
                    entityTitle = pr.Title;
                    entityType = "PR";
                }
                else
                {
                    try
                    {
                        var issue = await IssueApi.GetIssueAsync(entityId, ProjectId);
                        if (issue != null)
                        {
                            entityTitle = issue.Title;
                            entityType = "Issue";
                        }
                    }
                    catch { }
                }
            }
            catch { }

            entityGroups.Add(new EntityGroupInfo
            {
                EntityId = entityId,
                EntityTitle = entityTitle,
                EntityType = entityType,
                Sessions = group.ToList()
            });
        }

        // Sort: entities with more sessions first (likely have orphans), then by title
        _entityGroups = entityGroups
            .OrderByDescending(g => g.Sessions.Count)
            .ThenBy(g => g.EntityTitle)
            .ToList();
    }

    private async Task StopSession(string sessionId)
    {
        _stoppingSessions.Add(sessionId);
        _errorMessage = null;

        try
        {
            await SessionApi.StopSessionAsync(sessionId);
            await RefreshData();
            await OnDataChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to stop session: {ex.Message}";
        }
        finally
        {
            _stoppingSessions.Remove(sessionId);
        }
    }

    private async Task StopAllForEntity(string entityId)
    {
        _stoppingEntities.Add(entityId);
        _errorMessage = null;

        try
        {
            var stopped = await SessionApi.StopAllSessionsForEntityAsync(entityId);
            await RefreshData();
            await OnDataChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to stop sessions: {ex.Message}";
        }
        finally
        {
            _stoppingEntities.Remove(entityId);
        }
    }

    private static string FormatUptime(TimeSpan uptime)
    {
        if (uptime.TotalDays >= 1)
            return $"{(int)uptime.TotalDays}d {uptime.Hours}h";
        if (uptime.TotalHours >= 1)
            return $"{(int)uptime.TotalHours}h {uptime.Minutes}m";
        if (uptime.TotalMinutes >= 1)
            return $"{(int)uptime.TotalMinutes}m {uptime.Seconds}s";
        return $"{uptime.Seconds}s";
    }

    private static string GetEntityTypeBadgeClass(string entityType) => entityType.ToLowerInvariant() switch
    {
        "pr" => "pr",
        "issue" => "issue",
        _ => "pr"
    };

    private static string GetModelDisplayName(string model)
    {
        var parts = model.Split('/');
        return parts.Length > 1 ? parts[1] : model;
    }

    private class EntityGroupInfo
    {
        public required string EntityId { get; set; }
        public required string EntityTitle { get; set; }
        public required string EntityType { get; set; }
        public required List<SessionSummary> Sessions { get; set; }
    }
}
