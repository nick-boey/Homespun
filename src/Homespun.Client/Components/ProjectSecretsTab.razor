@inject HttpSecretsApiService SecretsApi

<div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Project Secrets</h5>
    <button class="btn btn-primary btn-sm" @onclick="ShowAddModal">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-1">
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
        </svg>
        Add Secret
    </button>
</div>

<div class="alert alert-warning small mb-3">
    <i class="bi bi-shield-exclamation me-1"></i>
    <strong>Security Note:</strong> Secrets are stored in a <code>secrets.env</code> file in your project folder.
    This file is not encrypted. Do not commit this file to source control.
</div>

<p class="text-muted small mb-3">
    Environment variables configured here will be injected into worker containers when agents start on this project.
</p>

@if (_isLoading)
{
    <LoadingSpinner Label="Loading secrets..." />
}
else if (!_secrets.Any())
{
    <EmptyState
        Title="No Secrets Configured"
        Description="Add environment variables that will be injected into worker containers for this project."
        ActionLabel="Add Secret"
        ActionClick="ShowAddModal">
        <Icon>
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
            </svg>
        </Icon>
    </EmptyState>
}
else
{
    <div class="table-responsive">
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Value</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var secret in _secrets)
                {
                    <tr>
                        <td><code>@secret.Name</code></td>
                        <td><span class="text-muted">********</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-secondary me-1" @onclick="() => ShowEditModal(secret)">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => ShowDeleteConfirmation(secret)">
                                Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<Modal IsOpen="@_showModal"
       OnClose="@HideModal"
       Title="@(_editingSecret == null ? "Add Secret" : "Edit Secret")"
       Size="ModalSize.Default">
    <Body>
        <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text"
                   class="form-control font-monospace"
                   @bind="_modalName"
                   placeholder="e.g., API_KEY, DATABASE_URL"
                   disabled="@(_editingSecret != null)" />
            <div class="form-text">
                Must start with a letter or underscore, followed by letters, digits, or underscores only.
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Value</label>
            <input type="password"
                   class="form-control font-monospace"
                   @bind="_modalValue"
                   placeholder="Secret value..." />
            <div class="form-text">
                @if (_editingSecret != null)
                {
                    <text>Enter the new value. Leave empty to keep the existing value.</text>
                }
                else
                {
                    <text>The value will be stored in the project's <code>secrets.env</code> file.</text>
                }
            </div>
        </div>
    </Body>
    <Footer>
        @if (!string.IsNullOrEmpty(_modalError))
        {
            <div class="text-danger me-auto">@_modalError</div>
        }
        <button type="button" class="btn btn-secondary" @onclick="HideModal">Cancel</button>
        <AsyncActionButton OnClick="SaveSecret"
                           IsLoadingExternal="_isSaving"
                           CssClass="btn-primary"
                           Text="Save" />
    </Footer>
</Modal>

<ConfirmModal IsOpen="@(_showDeleteConfirmation && _secretToDelete != null)"
              OnCancel="@HideDeleteConfirmation"
              OnConfirm="@DeleteSecret"
              Title="Delete Secret"
              ConfirmText="Delete"
              ConfirmVariant="ConfirmButtonVariant.Danger"
              IsProcessing="@_isDeleting">
    <p>Are you sure you want to delete the secret <strong><code>@_secretToDelete?.Name</code></strong>?</p>
    <p class="text-muted mb-0">This action cannot be undone. Any containers using this secret will no longer have access to it.</p>
</ConfirmModal>

@code {
    [Parameter] public required string ProjectId { get; set; }

    private IReadOnlyList<SecretInfo> _secrets = [];
    private bool _isLoading = true;
    private bool _showModal;
    private bool _showDeleteConfirmation;
    private bool _isSaving;
    private bool _isDeleting;
    private string? _modalError;
    private SecretInfo? _editingSecret;
    private SecretInfo? _secretToDelete;

    // Modal form fields
    private string _modalName = string.Empty;
    private string _modalValue = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await RefreshSecrets();
    }

    private async Task RefreshSecrets()
    {
        _isLoading = true;
        try
        {
            _secrets = await SecretsApi.GetSecretsAsync(ProjectId);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ShowAddModal()
    {
        _editingSecret = null;
        _modalName = string.Empty;
        _modalValue = string.Empty;
        _modalError = null;
        _showModal = true;
    }

    private void ShowEditModal(SecretInfo secret)
    {
        _editingSecret = secret;
        _modalName = secret.Name;
        _modalValue = string.Empty; // Don't show the actual value
        _modalError = null;
        _showModal = true;
    }

    private void HideModal()
    {
        _showModal = false;
        _editingSecret = null;
        _modalError = null;
    }

    private async Task SaveSecret()
    {
        if (string.IsNullOrWhiteSpace(_modalName))
        {
            _modalError = "Name is required.";
            return;
        }

        if (_editingSecret == null && string.IsNullOrWhiteSpace(_modalValue))
        {
            _modalError = "Value is required.";
            return;
        }

        _isSaving = true;
        _modalError = null;

        try
        {
            if (_editingSecret == null)
            {
                await SecretsApi.CreateSecretAsync(ProjectId, _modalName.Trim(), _modalValue);
            }
            else if (!string.IsNullOrWhiteSpace(_modalValue))
            {
                await SecretsApi.UpdateSecretAsync(ProjectId, _modalName, _modalValue);
            }
            else
            {
                // No value change, just close the modal
                HideModal();
                return;
            }

            await RefreshSecrets();
            HideModal();
        }
        catch (HttpRequestException ex)
        {
            _modalError = ex.Message.Contains("400")
                ? "Invalid secret name. Use only letters, digits, and underscores, starting with a letter or underscore."
                : ex.Message;
        }
        catch (Exception ex)
        {
            _modalError = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void ShowDeleteConfirmation(SecretInfo secret)
    {
        _secretToDelete = secret;
        _showDeleteConfirmation = true;
    }

    private void HideDeleteConfirmation()
    {
        _showDeleteConfirmation = false;
        _secretToDelete = null;
    }

    private async Task DeleteSecret()
    {
        if (_secretToDelete == null) return;

        _isDeleting = true;
        try
        {
            await SecretsApi.DeleteSecretAsync(ProjectId, _secretToDelete.Name);
            await RefreshSecrets();
            HideDeleteConfirmation();
        }
        finally
        {
            _isDeleting = false;
        }
    }
}
