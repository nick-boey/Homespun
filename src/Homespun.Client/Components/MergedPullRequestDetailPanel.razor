@using Fleece.Core.Models
@using Homespun.Shared.Models.Fleece
@using Homespun.Shared.Models.PullRequests

@inject NavigationManager NavigationManager
@inject IMarkdownRenderingService MarkdownService

<div class="card merged-pull-request-detail-panel">
    <div class="card-header flex justify-between items-center">
        <span>Merged Pull Request</span>
        <button type="button" class="btn-close" @onclick="OnClose"></button>
    </div>
    <div class="card-body">
        <h5 class="card-title">@Details.PullRequest.Title</h5>

        <div class="mb-3">
            <span class="badge bg-purple">Merged</span>
            @if (!string.IsNullOrEmpty(Details.PullRequest.HtmlUrl))
            {
                <a href="@Details.PullRequest.HtmlUrl"
                   target="_blank"
                   class="badge bg-secondary text-decoration-none ml-1">
                    PR #@Details.PullRequest.Number
                </a>
            }
        </div>

        @if (!string.IsNullOrEmpty(Details.PullRequest.Body))
        {
            <div class="description-content markdown-content mb-3">
                @((MarkupString)MarkdownService.RenderToHtml(Details.PullRequest.Body))
            </div>
        }

        @* Linked Issue Section *@
        @if (Details.LinkedIssue != null)
        {
            <div class="border rounded p-2 mb-3 bg-surface-secondary">
                <div class="flex justify-between items-start">
                    <h6 class="mb-2">
                        <span class="badge bg-status-info text-text-primary mr-1">@Details.LinkedIssue.Id</span>
                        Linked Issue
                    </h6>
                    <a href="/projects/@ProjectId/issues/@Details.LinkedIssue.Id/edit"
                       class="btn btn-sm btn-outline-primary">
                        Edit
                    </a>
                </div>
                <p class="mb-1 font-bold">@Details.LinkedIssue.Title</p>
                <div class="mb-1">
                    <span class="badge @GetIssueTypeBadgeClass(Details.LinkedIssue.Type)">@Details.LinkedIssue.Type</span>
                    <span class="badge @GetIssueStatusBadgeClass(Details.LinkedIssue.Status)">@Details.LinkedIssue.Status</span>
                    @if (Details.LinkedIssue.Priority.HasValue)
                    {
                        <span class="badge bg-secondary">P@Details.LinkedIssue.Priority</span>
                    }
                </div>
                @if (!string.IsNullOrEmpty(Details.LinkedIssue.Description))
                {
                    <p class="mb-0 text-sm text-text-muted">@TruncateDescription(Details.LinkedIssue.Description, 150)</p>
                }
            </div>
        }
        else if (!string.IsNullOrEmpty(Details.LinkedIssueId))
        {
            <div class="border rounded p-2 mb-3 bg-surface-secondary">
                <h6 class="mb-2">
                    <span class="badge bg-status-info text-text-primary mr-1">@Details.LinkedIssueId</span>
                    Linked Issue
                    <span class="text-text-muted text-sm">(not found)</span>
                </h6>
            </div>
        }

        <dl class="grid grid-cols-12 text-sm">
            @if (!string.IsNullOrEmpty(Details.PullRequest.BranchName))
            {
                <dt class="col-span-4">Branch</dt>
                <dd class="col-span-8"><code>@Details.PullRequest.BranchName</code></dd>
            }
            @if (Details.PullRequest.MergedAt.HasValue)
            {
                <dt class="col-span-4">Merged</dt>
                <dd class="col-span-8">@Details.PullRequest.MergedAt.Value.ToLocalTime().ToString("g")</dd>
            }
            <dt class="col-span-4">Created</dt>
            <dd class="col-span-8">@Details.PullRequest.CreatedAt.ToLocalTime().ToString("g")</dd>
        </dl>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public required MergedPullRequestDetails Details { get; set; }

    [Parameter, EditorRequired]
    public required string ProjectId { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private static string TruncateDescription(string description, int maxLength)
    {
        if (string.IsNullOrEmpty(description) || description.Length <= maxLength)
            return description;
        return description[..maxLength] + "...";
    }

    private static string GetIssueTypeBadgeClass(IssueType type) => type switch
    {
        IssueType.Bug => "bg-danger",
        IssueType.Feature => "bg-primary",
        IssueType.Chore => "bg-secondary",
        IssueType.Task => "bg-info",
        _ => "bg-secondary"
    };

    private static string GetIssueStatusBadgeClass(IssueStatus status) => status switch
    {
        IssueStatus.Open => "bg-status-info",
        IssueStatus.Progress => "bg-primary",
        IssueStatus.Review => "bg-warning",
        IssueStatus.Complete => "bg-success",
        IssueStatus.Closed => "bg-secondary",
        IssueStatus.Archived => "bg-secondary",
        _ => "bg-secondary"
    };
}
