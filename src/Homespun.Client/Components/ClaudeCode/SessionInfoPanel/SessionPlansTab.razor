@using Homespun.Shared.Models.Plans
@inject HttpPlansApiService PlansApi
@inject IJSRuntime JSRuntime

<div class="plans-tab">
    @if (string.IsNullOrEmpty(WorkingDirectory))
    {
        <div class="empty-state">
            <span class="empty-icon">ðŸ“‹</span>
            <p>No working directory available</p>
        </div>
    }
    else if (_isLoading)
    {
        <div class="loading-state">
            <BbSpinner Size="SpinnerSize.Small" />
            <span>Loading plans...</span>
        </div>
    }
    else if (_plans.Count == 0)
    {
        <div class="empty-state">
            <span class="empty-icon">ðŸ“‹</span>
            <p>No plans found</p>
        </div>
    }
    else
    {
        <div class="plans-header">
            <span class="plan-count">@_plans.Count plan@(_plans.Count != 1 ? "s" : "")</span>
        </div>
        <div class="plans-list">
            @foreach (var plan in _plans)
            {
                <div class="plan-item">
                    <div class="plan-header">
                        <div class="plan-info">
                            <span class="plan-filename" title="@plan.FileName">@plan.FileName</span>
                            <span class="plan-metadata">
                                @FormatDate(plan.LastModified) Â· @FormatSize(plan.FileSizeBytes)
                            </span>
                        </div>
                        <div class="plan-actions">
                            <button class="action-button" title="Copy path" @onclick="() => CopyToClipboard(plan.FilePath)">
                                ðŸ“‹
                            </button>
                            <button class="action-button" title="Copy content" @onclick="() => CopyPlanContent(plan.FileName)">
                                ðŸ“„
                            </button>
                            <button class="action-button expand-button" title="@(_expandedPlans.Contains(plan.FileName) ? "Collapse" : "Expand")"
                                    @onclick="() => ToggleExpand(plan.FileName)">
                                @(_expandedPlans.Contains(plan.FileName) ? "â–¼" : "â–¶")
                            </button>
                        </div>
                    </div>
                    @if (_expandedPlans.Contains(plan.FileName))
                    {
                        <div class="plan-content">
                            @if (_loadingContent.Contains(plan.FileName))
                            {
                                <div class="content-loading">
                                    <BbSpinner Size="SpinnerSize.Small" />
                                    <span>Loading...</span>
                                </div>
                            }
                            else if (_planContents.TryGetValue(plan.FileName, out var content))
                            {
                                <pre class="content-text">@content</pre>
                            }
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(plan.Preview))
                    {
                        <div class="plan-preview">@plan.Preview</div>
                    }
                </div>
            }
        </div>
    }
</div>

<style>
    .plans-tab {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .loading-state,
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-lg);
        color: var(--text-muted);
        text-align: center;
        gap: var(--spacing-sm);
    }

    .empty-icon {
        font-size: 2rem;
        opacity: 0.5;
    }

    .empty-state p {
        margin: 0;
        font-size: 0.875rem;
    }

    .plans-header {
        padding: var(--spacing-sm);
        border-bottom: 1px solid var(--border-color);
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .plans-list {
        flex: 1;
        overflow-y: auto;
    }

    .plan-item {
        border-bottom: 1px solid var(--border-color);
    }

    .plan-item:last-child {
        border-bottom: none;
    }

    .plan-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm);
    }

    .plan-header:hover {
        background: var(--bg-secondary);
    }

    .plan-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
        flex: 1;
    }

    .plan-filename {
        font-family: monospace;
        font-size: 0.8125rem;
        color: var(--text-primary);
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .plan-metadata {
        font-size: 0.6875rem;
        color: var(--text-muted);
    }

    .plan-actions {
        display: flex;
        gap: 2px;
        flex-shrink: 0;
    }

    .action-button {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        transition: background 0.15s ease, color 0.15s ease;
    }

    .action-button:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .plan-preview {
        padding: 0 var(--spacing-sm) var(--spacing-sm);
        font-size: 0.75rem;
        color: var(--text-muted);
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-word;
        border-left: 2px solid var(--border-color);
        margin-left: var(--spacing-sm);
        padding-left: var(--spacing-sm);
    }

    .plan-content {
        padding: var(--spacing-sm);
        background: var(--bg-tertiary);
        border-top: 1px solid var(--border-color);
    }

    .content-loading {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    .content-text {
        margin: 0;
        font-size: 0.75rem;
        color: var(--text-secondary);
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 300px;
        overflow-y: auto;
    }
</style>

@code {
    [Parameter] public string? WorkingDirectory { get; set; }

    private List<PlanFileInfo> _plans = [];
    private bool _isLoading = true;
    private HashSet<string> _expandedPlans = [];
    private HashSet<string> _loadingContent = [];
    private Dictionary<string, string> _planContents = [];

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(WorkingDirectory))
        {
            await LoadPlansAsync();
        }
        else
        {
            _isLoading = false;
        }
    }

    private async Task LoadPlansAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            _plans = await PlansApi.GetPlanFilesAsync(WorkingDirectory!);
        }
        catch
        {
            _plans = [];
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ToggleExpand(string fileName)
    {
        if (_expandedPlans.Contains(fileName))
        {
            _expandedPlans.Remove(fileName);
        }
        else
        {
            _expandedPlans.Add(fileName);

            // Load content if not already loaded
            if (!_planContents.ContainsKey(fileName))
            {
                await LoadPlanContentAsync(fileName);
            }
        }
        StateHasChanged();
    }

    private async Task LoadPlanContentAsync(string fileName)
    {
        _loadingContent.Add(fileName);
        StateHasChanged();

        try
        {
            var content = await PlansApi.GetPlanContentAsync(WorkingDirectory!, fileName);
            if (content != null)
            {
                _planContents[fileName] = content;
            }
        }
        catch
        {
            _planContents[fileName] = "Error loading content";
        }
        finally
        {
            _loadingContent.Remove(fileName);
            StateHasChanged();
        }
    }

    private async Task CopyToClipboard(string text)
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
    }

    private async Task CopyPlanContent(string fileName)
    {
        // Load content if not cached
        if (!_planContents.TryGetValue(fileName, out var content))
        {
            content = await PlansApi.GetPlanContentAsync(WorkingDirectory!, fileName);
        }

        if (!string.IsNullOrEmpty(content))
        {
            await CopyToClipboard(content);
        }
    }

    private static string FormatDate(DateTime date)
    {
        var diff = DateTime.Now - date;
        if (diff.TotalMinutes < 1) return "just now";
        if (diff.TotalHours < 1) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalDays < 1) return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d ago";
        return date.ToString("MMM d");
    }

    private static string FormatSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }
}
