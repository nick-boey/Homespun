@*
    AsyncActionButton Component

    A reusable button component that handles loading state, disabled state,
    and customizable button text/styling for async operations.

    Usage:
    <AsyncActionButton OnClick="HandleSubmitAsync"
                       Text="Save"
                       LoadingText="Saving..."
                       Variant="ButtonVariant.Default" />
*@

<BbButton Variant="@Variant"
          Size="@GetSize()"
          Disabled="@(IsLoading || Disabled)"
          Loading="@IsLoading"
          OnClick="HandleClick"
          Class="@CssClass"
          Type="@GetButtonType()">
    @if (IsLoading)
    {
        @if (!string.IsNullOrEmpty(LoadingText))
        {
            <span>@LoadingText</span>
        }
        else if (!string.IsNullOrEmpty(Text))
        {
            <span>@Text</span>
        }
    }
    else
    {
        @if (IconContent != null)
        {
            @IconContent
        }
        @if (!string.IsNullOrEmpty(Text))
        {
            <span>@Text</span>
        }
        @ChildContent
    }
</BbButton>

@code {
    /// <summary>
    /// The click handler for the button. Can be async.
    /// </summary>
    [Parameter]
    public EventCallback<MouseEventArgs> OnClick { get; set; }

    /// <summary>
    /// The text to display on the button when not loading.
    /// </summary>
    [Parameter]
    public string? Text { get; set; }

    /// <summary>
    /// The text to display when loading. If not set, uses Text.
    /// </summary>
    [Parameter]
    public string? LoadingText { get; set; }

    /// <summary>
    /// Button variant style.
    /// </summary>
    [Parameter]
    public ButtonVariant Variant { get; set; } = ButtonVariant.Default;

    /// <summary>
    /// Button size.
    /// </summary>
    [Parameter]
    public ButtonSize? Size { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the button.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// Whether the button is in a loading state. If not provided, managed internally when OnClick is async.
    /// </summary>
    [Parameter]
    public bool? IsLoadingExternal { get; set; }

    /// <summary>
    /// Whether the button is disabled (independent of loading state).
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// The button type attribute. Defaults to "button".
    /// </summary>
    [Parameter]
    public string ButtonType { get; set; } = "button";

    /// <summary>
    /// Optional icon content to display before the text.
    /// </summary>
    [Parameter]
    public RenderFragment? IconContent { get; set; }

    /// <summary>
    /// Optional child content to display after the text.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private bool _isLoadingInternal;

    /// <summary>
    /// Gets whether the button is currently loading.
    /// Uses external state if provided, otherwise uses internal state.
    /// </summary>
    private bool IsLoading => IsLoadingExternal ?? _isLoadingInternal;

    private ButtonSize GetSize() => Size ?? ButtonSize.Default;

    private ButtonType GetButtonType() => ButtonType switch
    {
        "submit" => BlazorBlueprint.Components.ButtonType.Submit,
        "reset" => BlazorBlueprint.Components.ButtonType.Reset,
        _ => BlazorBlueprint.Components.ButtonType.Button
    };

    private async Task HandleClick(MouseEventArgs args)
    {
        if (IsLoading || Disabled)
            return;

        // If external loading state is used, don't manage internal state
        if (IsLoadingExternal.HasValue)
        {
            await OnClick.InvokeAsync(args);
            return;
        }

        // Manage loading state internally
        _isLoadingInternal = true;
        StateHasChanged();

        try
        {
            await OnClick.InvokeAsync(args);
        }
        finally
        {
            _isLoadingInternal = false;
            StateHasChanged();
        }
    }
}
