@namespace Homespun.Client.Components

@if (string.IsNullOrEmpty(Text))
{
    return;
}

@if (string.IsNullOrEmpty(SearchTerm))
{
    @Text
}
else
{
    @foreach (var segment in GetSegments())
    {
        @if (segment.IsMatch)
        {
            <mark class="search-highlight">@segment.Text</mark>
        }
        else
        {
            @segment.Text
        }
    }
}

@code {
    /// <summary>
    /// The full text to display.
    /// </summary>
    [Parameter] public string? Text { get; set; }

    /// <summary>
    /// The search term to highlight (case-insensitive).
    /// </summary>
    [Parameter] public string? SearchTerm { get; set; }

    private record TextSegment(string Text, bool IsMatch);

    private IEnumerable<TextSegment> GetSegments()
    {
        if (string.IsNullOrEmpty(Text) || string.IsNullOrEmpty(SearchTerm))
        {
            if (!string.IsNullOrEmpty(Text))
            {
                yield return new TextSegment(Text, false);
            }
            yield break;
        }

        var index = 0;
        var searchLen = SearchTerm.Length;

        while (index < Text.Length)
        {
            var matchIndex = Text.IndexOf(SearchTerm, index, StringComparison.OrdinalIgnoreCase);

            if (matchIndex < 0)
            {
                // No more matches - yield remainder
                yield return new TextSegment(Text[index..], false);
                yield break;
            }

            // Yield text before the match
            if (matchIndex > index)
            {
                yield return new TextSegment(Text[index..matchIndex], false);
            }

            // Yield the matched text (preserving original casing)
            yield return new TextSegment(Text.Substring(matchIndex, searchLen), true);
            index = matchIndex + searchLen;
        }
    }
}
