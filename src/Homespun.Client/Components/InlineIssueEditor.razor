@using Homespun.Client.Services

@inject IKeyboardNavigationService NavService
@inject IJSRuntime JSRuntime

<div class="inline-issue-editor" data-testid="inline-issue-create">
    <input type="text"
           class="inline-issue-input"
           value="@Title"
           @oninput="HandleInput"
           @onkeydown="HandleKeyDown"
           @onkeydown:stopPropagation="true"
           @onblur="HandleBlur"
           @ref="_inputElement"
           placeholder="@Placeholder" />
</div>

<style>
    .inline-issue-editor {
        flex: 1;
        min-width: 0;
    }

    .inline-issue-input {
        width: 100%;
        background: var(--bg-primary, #1a1a2e);
        border: 2px solid var(--color-ocean, #51A5C1);
        border-radius: 4px;
        padding: 4px 8px;
        color: var(--text-primary, #eaeaea);
        font-size: 14px;
        outline: none;
        box-shadow: 0 0 8px rgba(81, 165, 193, 0.3);
    }

    .inline-issue-input:focus {
        border-color: var(--color-ocean, #51A5C1);
        box-shadow: 0 0 12px rgba(81, 165, 193, 0.5);
    }

    .inline-issue-input::placeholder {
        color: var(--text-muted, #6c757d);
    }
</style>

@code {
    [Parameter] public string Title { get; set; } = "";
    [Parameter] public EventCallback<string> TitleChanged { get; set; }
    [Parameter] public string Placeholder { get; set; } = "Enter issue title...";
    [Parameter] public EditCursorPosition CursorPosition { get; set; } = EditCursorPosition.End;

    private ElementReference _inputElement;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await FocusInputAsync();
        }
    }

    private async Task FocusInputAsync()
    {
        try
        {
            var cursorPos = CursorPosition switch
            {
                EditCursorPosition.Start => "start",
                EditCursorPosition.End => "end",
                EditCursorPosition.Replace => "replace",
                _ => "end"
            };
            await JSRuntime.InvokeVoidAsync("homespunInterop.focusWithCursor", _inputElement, cursorPos, Title.Length);
        }
        catch
        {
            // Focus might fail if element is not in DOM yet
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        switch (e.Key)
        {
            case "Escape":
                NavService.CancelEdit();
                break;
            case "Enter":
                await NavService.AcceptEditAsync();
                break;
            case "Tab":
                // Tab default is prevented via JS in focusWithCursor
                if (e.ShiftKey)
                {
                    NavService.UnindentAsSibling();
                }
                else
                {
                    NavService.IndentAsChild();
                }
                break;
        }
    }

    private async Task HandleInput(ChangeEventArgs e)
    {
        Title = e.Value?.ToString() ?? "";
        await TitleChanged.InvokeAsync(Title);
        NavService.UpdateEditTitle(Title);
    }

    private void HandleBlur()
    {
        // Don't cancel on blur - let user click elsewhere while editing
        // The user must explicitly press Escape to cancel or Enter to save
    }
}
