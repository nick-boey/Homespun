# Komodo Docker Compose for Homespun
# This compose file runs Komodo with MongoDB for container management.
#
# Usage:
#   docker compose -f komodo.compose.yml --env-file compose.env up -d
#   docker compose -f komodo.compose.yml --env-file compose.env --profile tailscale up -d
#
# Services:
#   - mongo: MongoDB database
#   - core: Komodo Core API and UI (port 9120)
#   - periphery: Komodo agent for executing Docker commands
#   - tailscale: VPN sidecar for secure remote access (profile: tailscale)
#
# Integration:
#   - Logs are collected by Promtail (labels: logging=promtail)
#   - Access via Tailscale on port 3500 (when tailscale profile is enabled)

services:
  # MongoDB - Database for Komodo
  mongo:
    image: mongo:7
    container_name: homespun-komodo-mongo
    labels:
      komodo.skip: true
      logging: promtail
      logging_jobname: komodo-mongo
    command: --quiet --wiredTigerCacheSizeGB 0.25
    restart: unless-stopped
    volumes:
      - komodo-mongo-data:/data/db
      - komodo-mongo-config:/data/configdb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${KOMODO_DB_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${KOMODO_DB_PASSWORD}
    networks:
      - homespun-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Komodo Core - API and Web UI
  core:
    image: ghcr.io/moghtech/komodo-core:${COMPOSE_KOMODO_IMAGE_TAG:-latest}
    container_name: homespun-komodo-core
    labels:
      komodo.skip: true
      logging: promtail
      logging_jobname: komodo-core
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
    ports:
      - "9120:9120"
    env_file: ./compose.env
    environment:
      KOMODO_DATABASE_ADDRESS: homespun-komodo-mongo:27017
      KOMODO_DATABASE_USERNAME: ${KOMODO_DB_USERNAME}
      KOMODO_DATABASE_PASSWORD: ${KOMODO_DB_PASSWORD}
    volumes:
      - ${COMPOSE_KOMODO_BACKUPS_PATH:-/etc/komodo/backups}:/backups
    networks:
      - homespun-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9120"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # Komodo Periphery - Agent for Docker operations
  periphery:
    image: ghcr.io/moghtech/komodo-periphery:${COMPOSE_KOMODO_IMAGE_TAG:-latest}
    container_name: homespun-komodo-periphery
    labels:
      komodo.skip: true
      logging: promtail
      logging_jobname: komodo-periphery
    restart: unless-stopped
    depends_on:
      core:
        condition: service_healthy
    environment:
      PERIPHERY_ROOT_DIRECTORY: ${PERIPHERY_ROOT_DIRECTORY:-/etc/komodo}
      PERIPHERY_PASSKEYS: ${KOMODO_PASSKEY}
      PERIPHERY_SSL_ENABLED: true
      PERIPHERY_DISABLE_TERMINALS: false
      PERIPHERY_INCLUDE_DISK_MOUNTS: ${PERIPHERY_INCLUDE_DISK_MOUNTS:-/etc/hostname}
      DOCKER_CONFIG: /etc/komodo/docker
    volumes:
      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Proc for system metrics
      - /proc:/proc
      # Komodo data directory (must be same path inside and outside container)
      - ${PERIPHERY_ROOT_DIRECTORY:-/etc/komodo}:${PERIPHERY_ROOT_DIRECTORY:-/etc/komodo}
      # Docker config for registry auth (GHCR)
      - /etc/komodo/docker:/etc/komodo/docker:ro
    networks:
      - homespun-net

  # Tailscale - VPN sidecar for secure remote access
  # Exposes Komodo via HTTPS on port 3500
  # Uses a separate container name and state volume from the main Homespun
  # Tailscale sidecar to allow both to run simultaneously.
  tailscale:
    image: tailscale/tailscale:latest
    container_name: homespun-komodo-tailscale
    profiles: ["tailscale"]
    hostname: homespun-komodo-tailscale
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTH_KEY:-}
      - TS_HOSTNAME=${TS_HOSTNAME:-homespun-dev}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=true
      - TS_SERVE_CONFIG=/tmp/serve/serve-config.json
      - TS_EXTRA_ARGS=--accept-routes --reset
    volumes:
      - komodo-tailscale-state:/var/lib/tailscale
      - ${TAILSCALE_CONFIG_DIR:-./tailscale}:/config:ro
    entrypoint: ["/config/start.sh"]
    restart: unless-stopped
    networks:
      - homespun-net
    depends_on:
      core:
        condition: service_healthy

networks:
  homespun-net:
    external: true

volumes:
  komodo-mongo-data:
  komodo-mongo-config:
  komodo-tailscale-state:
