# Komodo Docker Compose for Homespun
# This compose file runs Komodo with MongoDB for container management.
#
# Usage:
#   docker compose -f komodo.compose.yml --env-file compose.env up -d
#
# Services:
#   - mongo: MongoDB database
#   - core: Komodo Core API and UI (port 9120)
#   - periphery: Komodo agent for executing Docker commands
#
# Integration:
#   - Logs are collected by Promtail (labels: logging=promtail)
#   - Access via Tailscale on port 3500 (configured in homespun tailscale sidecar)

services:
  # MongoDB - Database for Komodo
  mongo:
    image: mongo:7
    container_name: homespun-komodo-mongo
    labels:
      komodo.skip: true
      logging: promtail
      logging_jobname: komodo-mongo
    command: --quiet --wiredTigerCacheSizeGB 0.25
    restart: unless-stopped
    volumes:
      - komodo-mongo-data:/data/db
      - komodo-mongo-config:/data/configdb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${KOMODO_DB_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${KOMODO_DB_PASSWORD}
    networks:
      - homespun-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Komodo Core - API and Web UI
  core:
    image: ghcr.io/moghtech/komodo-core:${COMPOSE_KOMODO_IMAGE_TAG:-latest}
    container_name: homespun-komodo-core
    labels:
      komodo.skip: true
      logging: promtail
      logging_jobname: komodo-core
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
    ports:
      - "9120:9120"
    env_file: ./compose.env
    environment:
      KOMODO_DATABASE_ADDRESS: homespun-komodo-mongo:27017
      KOMODO_DATABASE_USERNAME: ${KOMODO_DB_USERNAME}
      KOMODO_DATABASE_PASSWORD: ${KOMODO_DB_PASSWORD}
    volumes:
      - ${COMPOSE_KOMODO_BACKUPS_PATH:-/etc/komodo/backups}:/backups
    networks:
      - homespun-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9120/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # Komodo Periphery - Agent for Docker operations
  periphery:
    image: ghcr.io/moghtech/komodo-periphery:${COMPOSE_KOMODO_IMAGE_TAG:-latest}
    container_name: homespun-komodo-periphery
    labels:
      komodo.skip: true
      logging: promtail
      logging_jobname: komodo-periphery
    restart: unless-stopped
    depends_on:
      core:
        condition: service_healthy
    env_file: ./compose.env
    environment:
      # Mount docker config for GHCR access
      DOCKER_CONFIG: /etc/komodo/docker
    volumes:
      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Proc for system metrics
      - /proc:/proc
      # Komodo data directory
      - ${PERIPHERY_ROOT_DIRECTORY:-/etc/komodo}:${PERIPHERY_ROOT_DIRECTORY:-/etc/komodo}
      # Docker config for registry auth (GHCR)
      - /etc/komodo/docker:/etc/komodo/docker:ro
    networks:
      - homespun-net

networks:
  homespun-net:
    external: true

volumes:
  komodo-mongo-data:
  komodo-mongo-config:
