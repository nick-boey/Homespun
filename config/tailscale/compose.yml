# Standalone Tailscale Sidecar
# Started by run.sh or run-komodo.sh â€” shared across all Homespun services.
# Dynamically discovers and proxies services on homespun-net.
#
# Usage (called by scripts, not directly):
#   TAILSCALE_AUTH_KEY=... TS_HOSTNAME=... docker compose -f config/tailscale/compose.yml up -d

services:
  tailscale:
    image: tailscale/tailscale:latest
    container_name: homespun-tailscale
    hostname: homespun-tailscale
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTH_KEY:-}
      - TS_HOSTNAME=${TS_HOSTNAME:-homespun-dev}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=true
      - TS_SERVE_CONFIG=/tmp/serve/serve-config.json
      - TS_EXTRA_ARGS=--accept-routes --reset
    volumes:
      - tailscale-state:/var/lib/tailscale
      - ./:/config:ro
    entrypoint: ["/config/start.sh"]
    restart: unless-stopped
    networks:
      - homespun-net

networks:
  homespun-net:
    external: true

volumes:
  tailscale-state:
